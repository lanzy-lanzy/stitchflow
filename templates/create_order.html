{% extends 'base.html' %}

{% block title %}Create Order - El Senior Dumingag{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto">
    <div class="bg-white rounded-xl shadow-lg p-8">
        <h1 class="text-2xl font-bold text-gray-800 mb-6 flex items-center">
            <i class="fas fa-shopping-cart text-green-600 mr-2"></i> Create New Order
        </h1>
        
        <div id="statusMessage" class="hidden mb-6 p-4 rounded-lg"></div>
        
        <form id="orderForm" class="space-y-6">
            {% csrf_token %}
            
            <!-- Order Details -->
            <div class="bg-gradient-to-r from-gray-50 to-gray-100 p-6 rounded-xl border border-gray-200 shadow-sm">
                <h2 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
                    <i class="fas fa-info-circle text-blue-600 mr-2"></i> Order Details
                </h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label for="customer" class="block text-sm font-medium text-gray-700 mb-1">Customer *</label>
                        <select id="customer" name="customer" required
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500">
                            <option value="">Select a customer</option>
                            <!-- Options will be populated dynamically -->
                        </select>
                    </div>
                    <div>
                        <label for="fabric" class="block text-sm font-medium text-gray-700 mb-1">Fabric *</label>
                        <select id="fabric" name="fabric" required
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500">
                            <option value="">Select a fabric</option>
                            <!-- Options will be populated dynamically -->
                        </select>
                    </div>
                    <div>
                        <label for="accessories" class="block text-sm font-medium text-gray-700 mb-1">Accessories</label>
                        <select id="accessories" name="accessories" multiple
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500">
                            <!-- Options will be populated dynamically -->
                        </select>
                    </div>
                    <div>
                        <label for="tailor" class="block text-sm font-medium text-gray-700 mb-1">Assign to Tailor (Optional)</label>
                        <select id="tailor" name="tailor"
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500">
                            <option value="">Do not assign (create pending order)</option>
                            <!-- Tailors will be populated dynamically -->
                        </select>
                        <div class="mt-1 text-sm text-gray-500">If selected, the order will be assigned to this tailor immediately after creation.</div>
                    </div>
                    <div>
                        <label for="total_amount" class="block text-sm font-medium text-gray-700 mb-1">Total Amount (₱) *</label>
                        <input type="number" id="total_amount" name="total_amount" step="0.01" required
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500" readonly>
                        <div class="mt-1 text-sm text-gray-500">This amount is automatically calculated based on selected fabric and accessories.</div>
                    </div>
                </div>
            </div>
            
            <!-- Customer Measurements -->
            <div class="bg-gradient-to-r from-gray-50 to-gray-100 p-6 rounded-xl border border-gray-200 shadow-sm">
                <h2 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
                    <i class="fas fa-ruler-vertical text-purple-600 mr-2"></i> Customer Measurements
                </h2>
                <div id="measurementsDisplay" class="text-gray-600">
                    <p>Select a customer to view their measurements</p>
                </div>
            </div>
            
            <div class="flex justify-end space-x-4">
                <button type="button" id="cancelBtn"
                    class="px-6 py-2 bg-gray-300 text-gray-700 font-medium rounded-lg hover:bg-gray-400 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500 transition-colors">
                    Cancel
                </button>
                <button type="submit" 
                    class="px-6 py-2 bg-green-600 text-white font-medium rounded-lg hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 transition-colors">
                    Create Order
                </button>
            </div>
        </form>
    </div>
</div>

<script>
    // Get CSRF token from the form and store in session
    const csrfTokenElement = document.querySelector('[name="csrfmiddlewaretoken"]');
    const csrfToken = csrfTokenElement ? csrfTokenElement.value : '';
    
    // Store token in sessionStorage for other requests
    if (csrfToken) {
        sessionStorage.setItem('csrfToken', csrfToken);
    }
    
    // Load customers, fabrics, and accessories when page loads
    document.addEventListener('DOMContentLoaded', function() {
        loadCustomers();
        loadFabrics();
        loadAccessories();
        loadTailors(); // Load tailors for assignment
        
        // Check if we're creating an order for a specific customer
        const customerId = localStorage.getItem('lastCreatedCustomerId');
        if (customerId) {
            setTimeout(() => {
                document.getElementById('customer').value = customerId;
                loadCustomerMeasurements(customerId);
            }, 500); // Small delay to ensure customers are loaded
        }
    });
    
    // Handle customer selection to load measurements
    document.getElementById('customer').addEventListener('change', function() {
        // Clear error styling
        this.classList.remove('border-red-500');
        
        const customerId = this.value;
        if (customerId) {
            loadCustomerMeasurements(customerId);
        } else {
            document.getElementById('measurementsDisplay').innerHTML = '<p>Select a customer to view their measurements</p>';
        }
    });
    
    // Handle fabric selection to update total amount
    document.getElementById('fabric').addEventListener('change', function() {
        // Clear error styling
        this.classList.remove('border-red-500');
        
        updateTotalAmount();
    });
    
    // Handle accessories selection to update total amount
    document.getElementById('accessories').addEventListener('change', function() {
        // Clear error styling
        this.classList.remove('border-red-500');
        
        updateTotalAmount();
    });
    
    // Handle form submission
    document.getElementById('orderForm').addEventListener('submit', function(e) {
        e.preventDefault();
        
        // Validate form fields
        const customer = document.getElementById('customer').value;
        const fabric = document.getElementById('fabric').value;
        const totalAmount = document.getElementById('total_amount').value;
        
        // Validate required fields
        if (!customer) {
            showStatusMessage('Please select a customer', 'error');
            return;
        }
        
        if (!fabric) {
            showStatusMessage('Please select a fabric', 'error');
            return;
        }
        
        if (!totalAmount || totalAmount <= 0) {
            showStatusMessage('Total amount must be greater than zero', 'error');
            return;
        }
        
        // Collect form data
        const orderData = {
            customer_id: customer,
            fabric_id: fabric,
            accessories_ids: Array.from(document.getElementById('accessories').selectedOptions).map(option => option.value),
            total_amount: totalAmount,
            status: 'PENDING'
        };
        
        // Debug log
        console.log('Submitting order data:', orderData);
        
        // Get selected tailor (if any)
        const tailorId = document.getElementById('tailor').value;
        
        // Submit the data
        fetch('/api/admin/orders/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': 'Token ' + (localStorage.getItem('authToken') || sessionStorage.getItem('authToken') || ''),
                'X-CSRFToken': csrfToken
            },
            credentials: 'include',
            body: JSON.stringify(orderData)
        })
        .then(response => {
            // Debug logging
            console.log('Server response status:', response.status);
            console.log('Response headers:', response.headers);
            
            if (!response.ok) {
                if (response.headers.get('content-type')?.includes('text/html')) {
                    // Server returned HTML instead of JSON (likely a login page)
                    console.error('Authentication error - received HTML response');
                    throw new Error('Authentication error. Please refresh the page and try again.');
                }
                return response.json().then(errors => {
                    console.error('Error response JSON:', errors);
                    throw new Error(JSON.stringify(errors));
                });
            }
            return response.json();
        })
        .then(data => {
            // Handle both paginated and non-paginated responses
            const order = data.results || data;
            
            // If a tailor was selected, assign the order to that tailor
            if (tailorId) {
                return fetch('/api/admin/assign-order/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Token ' + (localStorage.getItem('authToken') || sessionStorage.getItem('authToken') || ''),
                        'X-CSRFToken': csrfToken
                    },
                    credentials: 'include',
                    body: JSON.stringify({
                        order_id: order.id,
                        tailor_id: tailorId
                    })
                })
                .then(response => {
                    if (!response.ok) {
                        if (response.headers.get('content-type')?.includes('text/html')) {
                            // Server returned HTML instead of JSON (likely a login page)
                            console.error('Authentication error - received HTML response');
                            throw new Error('Authentication error. Please refresh the page and try again.');
                        }
                        return response.json().then(errors => {
                            throw new Error(JSON.stringify(errors));
                        });
                    }
                    return response.json();
                })
                .then(assignData => {
                    showStatusMessage('Order created and assigned to tailor successfully!', 'success');
                    return order; // Return original order data
                });
            } else {
                showStatusMessage('Order created successfully!', 'success');
                return order;
            }
        })
        .then(order => {
            // Reset the form
            document.getElementById('orderForm').reset();
            document.getElementById('measurementsDisplay').innerHTML = '<p>Select a customer to view their measurements</p>';
            
            // Redirect to admin dashboard after a short delay
            setTimeout(() => {
                window.location.href = '{% url "etailoring:admin_dashboard" %}';
            }, 2000);
        })
        .catch(error => {
            console.error('Error:', error);
            
            // Better error handling with debugging information
            let errorMessage = 'Error creating order';
            if (error.message) {
                try {
                    // Try to parse the error message as JSON
                    const errorObj = JSON.parse(error.message);
                    
                    // Format field-specific errors nicely
                    if (typeof errorObj === 'object') {
                        const fieldErrors = [];
                        for (const [field, errors] of Object.entries(errorObj)) {
                            // Format field name nicer
                            let fieldName = field.replace('_', ' ');
                            fieldName = fieldName.charAt(0).toUpperCase() + fieldName.slice(1);
                            
                            if (Array.isArray(errors)) {
                                fieldErrors.push(`${fieldName}: ${errors.join(', ')}`);
                            } else {
                                fieldErrors.push(`${fieldName}: ${errors}`);
                            }
                        }
                        
                        if (fieldErrors.length > 0) {
                            errorMessage = fieldErrors.join('\n');
                        } else {
                            errorMessage = JSON.stringify(errorObj);
                        }
                    } else {
                        errorMessage = JSON.stringify(errorObj);
                    }
                } catch (e) {
                    // If not JSON, use the error message directly
                    errorMessage = error.message;
                    
                    // Check specifically for customer_id errors
                    if (error.message.includes('customer_id') || error.message.includes('NOT NULL constraint failed')) {
                        errorMessage = 'Please select a customer';
                        document.getElementById('customer').classList.add('border-red-500');
                    }
                    
                    // Check for fabric_id errors
                    if (error.message.includes('fabric_id')) {
                        errorMessage = 'Please select a fabric';
                        document.getElementById('fabric').classList.add('border-red-500');
                    }
                    
                    // Check for many-to-many errors with accessories
                    if (error.message.includes('many-to-many') || error.message.includes('accessories')) {
                        errorMessage = 'Error with accessories selection. Please try again.';
                        document.getElementById('accessories').classList.add('border-red-500');
                        console.error('Many-to-many error details:', error.message);
                    }
                }
            }
            
            // Check for authentication issues
            if (error.message && error.message.includes('<!DOCTYPE')) {
                errorMessage = 'Authentication error. Please refresh the page and try again.';
                console.log('Received HTML instead of JSON. This usually indicates an authentication or session issue.');
            }
            
            showStatusMessage(errorMessage, 'error');
        });
    });
    
    // Handle cancel button
    document.getElementById('cancelBtn').addEventListener('click', function() {
        if (confirm('Are you sure you want to cancel? Any entered information will be lost.')) {
            window.location.href = '{% url "etailoring:admin_dashboard" %}';
        }
    });
    
    // Load customers from API
    function loadCustomers() {
        fetch('/api/admin/customers/', {
            headers: {
                'Authorization': 'Token ' + (localStorage.getItem('authToken') || sessionStorage.getItem('authToken') || ''),
                'X-CSRFToken': csrfToken,
                'Content-Type': 'application/json'
            },
            credentials: 'include'
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Failed to load customers: ' + response.status);
            }
            return response.json();
        })
        .then(data => {
            const customers = data.results || data; // Handle both paginated and non-paginated responses
            const customerSelect = document.getElementById('customer');
            // Clear existing options except the first one
            customerSelect.innerHTML = '<option value="">Select a customer</option>';
            
            customers.forEach(customer => {
                const option = document.createElement('option');
                option.value = customer.id;
                option.textContent = `${customer.user.first_name} ${customer.user.last_name} (${customer.user.username})`;
                customerSelect.appendChild(option);
            });
        })
        .catch(error => {
            console.error('Error loading customers:', error);
            showStatusMessage('Error loading customers. Please refresh the page.', 'error');
        });
    }
    
    // Load fabrics from API
    function loadFabrics() {
        fetch('/api/admin/fabrics/', {
            headers: {
                'Authorization': 'Token ' + (localStorage.getItem('authToken') || sessionStorage.getItem('authToken') || ''),
                'X-CSRFToken': csrfToken,
                'Content-Type': 'application/json'
            },
            credentials: 'include'
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Failed to load fabrics: ' + response.status);
            }
            return response.json();
        })
        .then(data => {
            const fabrics = data.results || data; // Handle both paginated and non-paginated responses
            const fabricSelect = document.getElementById('fabric');
            // Clear existing options except the first one
            fabricSelect.innerHTML = '<option value="">Select a fabric</option>';
            
            fabrics.forEach(fabric => {
                const option = document.createElement('option');
                option.value = fabric.id;
                option.textContent = `${fabric.name} (${fabric.unit_type}) - ₱${fabric.price_per_unit} per unit`;
                option.dataset.price = fabric.price_per_unit;
                fabricSelect.appendChild(option);
            });
        })
        .catch(error => {
            console.error('Error loading fabrics:', error);
            showStatusMessage('Error loading fabrics. Please refresh the page.', 'error');
        });
    }
    
    // Load accessories from API
    function loadAccessories() {
        fetch('/api/admin/accessories/', {
            headers: {
                'Authorization': 'Token ' + (localStorage.getItem('authToken') || sessionStorage.getItem('authToken') || ''),
                'X-CSRFToken': csrfToken,
                'Content-Type': 'application/json'
            },
            credentials: 'include'
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Failed to load accessories: ' + response.status);
            }
            return response.json();
        })
        .then(data => {
            const accessories = data.results || data; // Handle both paginated and non-paginated responses
            const accessoriesSelect = document.getElementById('accessories');
            // Clear existing options
            accessoriesSelect.innerHTML = '';
            
            accessories.forEach(accessory => {
                const option = document.createElement('option');
                option.value = accessory.id;
                option.textContent = `${accessory.name} - ₱${accessory.price_per_unit} per unit`;
                option.dataset.price = accessory.price_per_unit;
                accessoriesSelect.appendChild(option);
            });
        })
        .catch(error => {
            console.error('Error loading accessories:', error);
            showStatusMessage('Error loading accessories. Please refresh the page.', 'error');
        });
    }
    
    // Load tailors from API
    function loadTailors() {
        fetch('/api/admin/tailors/', {
            headers: {
                'Authorization': 'Token ' + (localStorage.getItem('authToken') || sessionStorage.getItem('authToken') || ''),
                'X-CSRFToken': csrfToken,
                'Content-Type': 'application/json'
            },
            credentials: 'include'
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Failed to load tailors: ' + response.status);
            }
            return response.json();
        })
        .then(data => {
            const tailors = data.results || data; // Handle both paginated and non-paginated responses
            const tailorSelect = document.getElementById('tailor');
            // Clear existing options except the first one
            tailorSelect.innerHTML = '<option value="">Do not assign (create pending order)</option>';
            
            tailors.forEach(tailor => {
                const option = document.createElement('option');
                option.value = tailor.id;
                option.textContent = `${tailor.user.first_name} ${tailor.user.last_name} (${tailor.specialty})`;
                tailorSelect.appendChild(option);
            });
        })
        .catch(error => {
            console.error('Error loading tailors:', error);
            showStatusMessage('Error loading tailors. Please refresh the page.', 'error');
        });
    }
    
    // Update total amount based on selected fabric and accessories
    function updateTotalAmount() {
        const fabricSelect = document.getElementById('fabric');
        const accessoriesSelect = document.getElementById('accessories');
        const totalAmountInput = document.getElementById('total_amount');
        
        let total = 0;
        
        // Add fabric price
        const selectedFabricOption = fabricSelect.options[fabricSelect.selectedIndex];
        if (selectedFabricOption && selectedFabricOption.dataset.price) {
            total += parseFloat(selectedFabricOption.dataset.price);
        }
        
        // Add accessories prices
        const selectedAccessories = Array.from(accessoriesSelect.selectedOptions);
        selectedAccessories.forEach(option => {
            if (option.dataset.price) {
                total += parseFloat(option.dataset.price);
            }
        });
        
        // Update the total amount input
        totalAmountInput.value = total.toFixed(2);
    }
    
    // Load customer measurements
    function loadCustomerMeasurements(customerId) {
        fetch(`/api/admin/customers/${customerId}/`, {
            headers: {
                'Authorization': 'Token ' + (localStorage.getItem('authToken') || sessionStorage.getItem('authToken') || ''),
                'X-CSRFToken': csrfToken,
                'Content-Type': 'application/json'
            },
            credentials: 'include'
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Failed to load customer measurements: ' + response.status);
            }
            return response.json();
        })
        .then(data => {
            // Handle both paginated and non-paginated responses
            const customer = data.results || data;
            
            const measurementsDisplay = document.getElementById('measurementsDisplay');
            if (customer.measurements && Object.keys(customer.measurements).length > 0) {
                let measurementsHtml = '<div class="grid grid-cols-2 md:grid-cols-3 gap-4">';
                for (const [key, value] of Object.entries(customer.measurements)) {
                    measurementsHtml += `
                        <div class="bg-white p-3 rounded border">
                            <div class="text-xs text-gray-500 uppercase">${key}</div>
                            <div class="font-medium">${value} inches</div>
                        </div>
                    `;
                }
                measurementsHtml += '</div>';
                measurementsDisplay.innerHTML = measurementsHtml;
            } else {
                measurementsDisplay.innerHTML = '<p class="text-gray-500">No measurements recorded for this customer</p>';
            }
        })
        .catch(error => {
            console.error('Error loading customer measurements:', error);
            document.getElementById('measurementsDisplay').innerHTML = '<p class="text-red-500">Error loading measurements</p>';
        });
    }
    
    function showStatusMessage(message, type) {
        const statusElement = document.getElementById('statusMessage');
        
        // Handle multiline messages
        if (message.includes('\n')) {
            const messageLines = message.split('\n');
            const messageHTML = messageLines.map(line => `<p>${line}</p>`).join('');
            statusElement.innerHTML = messageHTML;
        } else {
            statusElement.textContent = message;
        }
        
        statusElement.classList.remove('hidden', 'bg-green-100', 'text-green-800', 'bg-red-100', 'text-red-800');
        
        if (type === 'success') {
            statusElement.classList.add('bg-green-100', 'text-green-800');
        } else {
            statusElement.classList.add('bg-red-100', 'text-red-800');
        }
        
        statusElement.classList.remove('hidden');
        
        // Auto-hide success messages after 5 seconds
        if (type === 'success') {
            setTimeout(() => {
                statusElement.classList.add('hidden');
            }, 5000);
        }
    }
</script>
{% endblock %}