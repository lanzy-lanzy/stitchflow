{% extends 'base.html' %}

{% block title %}Create Order - El Senior Dumingag{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto">
    <div class="bg-white rounded-lg shadow-md p-8">
        <h1 class="text-2xl font-bold text-gray-800 mb-6">Create New Order</h1>
        
        <div id="statusMessage" class="hidden mb-6 p-4 rounded-md"></div>
        
        <form id="orderForm" class="space-y-6">
            {% csrf_token %}
            
            <!-- Order Details -->
            <div class="bg-gray-50 p-6 rounded-lg border border-gray-200">
                <h2 class="text-lg font-semibold text-gray-700 mb-4">Order Details</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label for="customer" class="block text-sm font-medium text-gray-700 mb-1">Customer *</label>
                        <select id="customer" name="customer" required
                            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500">
                            <option value="">Select a customer</option>
                            <!-- Options will be populated dynamically -->
                        </select>
                    </div>
                    <div>
                        <label for="fabric" class="block text-sm font-medium text-gray-700 mb-1">Fabric *</label>
                        <select id="fabric" name="fabric" required
                            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500">
                            <option value="">Select a fabric</option>
                            <!-- Options will be populated dynamically -->
                        </select>
                    </div>
                    <div>
                        <label for="accessories" class="block text-sm font-medium text-gray-700 mb-1">Accessories</label>
                        <select id="accessories" name="accessories" multiple
                            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500">
                            <!-- Options will be populated dynamically -->
                        </select>
                    </div>
                    <div>
                        <label for="tailor" class="block text-sm font-medium text-gray-700 mb-1">Assign to Tailor (Optional)</label>
                        <select id="tailor" name="tailor"
                            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500">
                            <option value="">Do not assign (create pending order)</option>
                            <!-- Tailors will be populated dynamically -->
                        </select>
                        <div class="mt-1 text-sm text-gray-500">If selected, the order will be assigned to this tailor immediately after creation.</div>
                    </div>
                    <div>
                        <label for="total_amount" class="block text-sm font-medium text-gray-700 mb-1">Total Amount ($) *</label>
                        <input type="number" id="total_amount" name="total_amount" step="0.01" required
                            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500" readonly>
                        <div class="mt-1 text-sm text-gray-500">This amount is automatically calculated based on selected fabric and accessories.</div>
                    </div>
                </div>
            </div>
            
            <!-- Customer Measurements -->
            <div class="bg-gray-50 p-6 rounded-lg border border-gray-200">
                <h2 class="text-lg font-semibold text-gray-700 mb-4">Customer Measurements</h2>
                <div id="measurementsDisplay" class="text-gray-600">
                    <p>Select a customer to view their measurements</p>
                </div>
            </div>
            
            <div class="flex justify-end space-x-4">
                <button type="button" id="cancelBtn"
                    class="px-6 py-2 bg-gray-300 text-gray-700 font-medium rounded-md hover:bg-gray-400 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500 transition-colors">
                    Cancel
                </button>
                <button type="submit" 
                    class="px-6 py-2 bg-indigo-600 text-white font-medium rounded-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-colors">
                    Create Order
                </button>
            </div>
        </form>
    </div>
</div>

<script>
    // Get CSRF token
    const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');
    
    // Load customers, fabrics, and accessories when page loads
    document.addEventListener('DOMContentLoaded', function() {
        loadCustomers();
        loadFabrics();
        loadAccessories();
        loadTailors(); // Load tailors for assignment
        
        // Check if we're creating an order for a specific customer
        const customerId = localStorage.getItem('lastCreatedCustomerId');
        if (customerId) {
            setTimeout(() => {
                document.getElementById('customer').value = customerId;
                loadCustomerMeasurements(customerId);
            }, 500); // Small delay to ensure customers are loaded
        }
    });
    
    // Handle customer selection to load measurements
    document.getElementById('customer').addEventListener('change', function() {
        const customerId = this.value;
        if (customerId) {
            loadCustomerMeasurements(customerId);
        } else {
            document.getElementById('measurementsDisplay').innerHTML = '<p>Select a customer to view their measurements</p>';
        }
    });
    
    // Handle fabric selection to update total amount
    document.getElementById('fabric').addEventListener('change', function() {
        updateTotalAmount();
    });
    
    // Handle accessories selection to update total amount
    document.getElementById('accessories').addEventListener('change', function() {
        updateTotalAmount();
    });
    
    // Handle form submission
    document.getElementById('orderForm').addEventListener('submit', function(e) {
        e.preventDefault();
        
        // Collect form data
        const orderData = {
            customer: document.getElementById('customer').value,
            fabric: document.getElementById('fabric').value,
            accessories: Array.from(document.getElementById('accessories').selectedOptions).map(option => option.value),
            total_amount: document.getElementById('total_amount').value,
            status: 'PENDING'
        };
        
        // Get selected tailor (if any)
        const tailorId = document.getElementById('tailor').value;
        
        // Submit the data
        fetch('/api/admin/orders/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': 'Token ' + localStorage.getItem('authToken'),
                'X-CSRFToken': csrfToken
            },
            body: JSON.stringify(orderData)
        })
        .then(response => {
            if (!response.ok) {
                return response.json().then(errors => {
                    throw new Error(JSON.stringify(errors));
                });
            }
            return response.json();
        })
        .then(data => {
            // If a tailor was selected, assign the order to that tailor
            if (tailorId) {
                return fetch('/api/admin/assign-order/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Token ' + localStorage.getItem('authToken'),
                        'X-CSRFToken': csrfToken
                    },
                    body: JSON.stringify({
                        order_id: data.id,
                        tailor_id: tailorId
                    })
                })
                .then(response => {
                    if (!response.ok) {
                        return response.json().then(errors => {
                            throw new Error(JSON.stringify(errors));
                        });
                    }
                    return response.json();
                })
                .then(assignData => {
                    showStatusMessage('Order created and assigned to tailor successfully!', 'success');
                    return data; // Return original order data
                });
            } else {
                showStatusMessage('Order created successfully!', 'success');
                return data;
            }
        })
        .then(data => {
            // Reset the form
            document.getElementById('orderForm').reset();
            document.getElementById('measurementsDisplay').innerHTML = '<p>Select a customer to view their measurements</p>';
            
            // Redirect to admin dashboard after a short delay
            setTimeout(() => {
                window.location.href = '{% url "etailoring:admin_dashboard" %}';
            }, 2000);
        })
        .catch(error => {
            console.error('Error:', error);
            showStatusMessage('Error creating order: ' + error.message, 'error');
        });
    });
    
    // Handle cancel button
    document.getElementById('cancelBtn').addEventListener('click', function() {
        if (confirm('Are you sure you want to cancel? Any entered information will be lost.')) {
            window.location.href = '{% url "etailoring:admin_dashboard" %}';
        }
    });
    
    // Load customers from API
    function loadCustomers() {
        fetch('/api/admin/customers/', {
            headers: {
                'Authorization': 'Token ' + localStorage.getItem('authToken'),
                'X-CSRFToken': csrfToken
            }
        })
        .then(response => response.json())
        .then(customers => {
            const customerSelect = document.getElementById('customer');
            // Clear existing options except the first one
            customerSelect.innerHTML = '<option value="">Select a customer</option>';
            
            customers.forEach(customer => {
                const option = document.createElement('option');
                option.value = customer.id;
                option.textContent = `${customer.user.first_name} ${customer.user.last_name} (${customer.user.username})`;
                customerSelect.appendChild(option);
            });
        })
        .catch(error => {
            console.error('Error loading customers:', error);
        });
    }
    
    // Load fabrics from API
    function loadFabrics() {
        fetch('/api/admin/fabrics/', {
            headers: {
                'Authorization': 'Token ' + localStorage.getItem('authToken'),
                'X-CSRFToken': csrfToken
            }
        })
        .then(response => response.json())
        .then(fabrics => {
            const fabricSelect = document.getElementById('fabric');
            // Clear existing options except the first one
            fabricSelect.innerHTML = '<option value="">Select a fabric</option>';
            
            fabrics.forEach(fabric => {
                const option = document.createElement('option');
                option.value = fabric.id;
                option.textContent = `${fabric.name} (${fabric.unit_type}) - $${fabric.price_per_unit} per unit`;
                option.dataset.price = fabric.price_per_unit;
                fabricSelect.appendChild(option);
            });
        })
        .catch(error => {
            console.error('Error loading fabrics:', error);
        });
    }
    
    // Load accessories from API
    function loadAccessories() {
        fetch('/api/admin/accessories/', {
            headers: {
                'Authorization': 'Token ' + localStorage.getItem('authToken'),
                'X-CSRFToken': csrfToken
            }
        })
        .then(response => response.json())
        .then(accessories => {
            const accessoriesSelect = document.getElementById('accessories');
            // Clear existing options
            accessoriesSelect.innerHTML = '';
            
            accessories.forEach(accessory => {
                const option = document.createElement('option');
                option.value = accessory.id;
                option.textContent = `${accessory.name} - $${accessory.price_per_unit} per unit`;
                option.dataset.price = accessory.price_per_unit;
                accessoriesSelect.appendChild(option);
            });
        })
        .catch(error => {
            console.error('Error loading accessories:', error);
        });
    }
    
    // Load tailors from API
    function loadTailors() {
        fetch('/api/admin/tailors/', {
            headers: {
                'Authorization': 'Token ' + localStorage.getItem('authToken'),
                'X-CSRFToken': csrfToken
            }
        })
        .then(response => response.json())
        .then(tailors => {
            const tailorSelect = document.getElementById('tailor');
            // Clear existing options except the first one
            tailorSelect.innerHTML = '<option value="">Do not assign (create pending order)</option>';
            
            tailors.forEach(tailor => {
                const option = document.createElement('option');
                option.value = tailor.id;
                option.textContent = `${tailor.user.first_name} ${tailor.user.last_name} (${tailor.specialty})`;
                tailorSelect.appendChild(option);
            });
        })
        .catch(error => {
            console.error('Error loading tailors:', error);
        });
    }
    
    // Update total amount based on selected fabric and accessories
    function updateTotalAmount() {
        const fabricSelect = document.getElementById('fabric');
        const accessoriesSelect = document.getElementById('accessories');
        const totalAmountInput = document.getElementById('total_amount');
        
        let total = 0;
        
        // Add fabric price
        const selectedFabricOption = fabricSelect.options[fabricSelect.selectedIndex];
        if (selectedFabricOption && selectedFabricOption.dataset.price) {
            total += parseFloat(selectedFabricOption.dataset.price);
        }
        
        // Add accessories prices
        const selectedAccessories = Array.from(accessoriesSelect.selectedOptions);
        selectedAccessories.forEach(option => {
            if (option.dataset.price) {
                total += parseFloat(option.dataset.price);
            }
        });
        
        // Update the total amount input
        totalAmountInput.value = total.toFixed(2);
    }
    
    // Load customer measurements
    function loadCustomerMeasurements(customerId) {
        fetch(`/api/admin/customers/${customerId}/`, {
            headers: {
                'Authorization': 'Token ' + localStorage.getItem('authToken'),
                'X-CSRFToken': csrfToken
            }
        })
        .then(response => response.json())
        .then(customer => {
            const measurementsDisplay = document.getElementById('measurementsDisplay');
            if (customer.measurements && Object.keys(customer.measurements).length > 0) {
                let measurementsHtml = '<div class="grid grid-cols-2 md:grid-cols-3 gap-4">';
                for (const [key, value] of Object.entries(customer.measurements)) {
                    measurementsHtml += `
                        <div class="bg-white p-3 rounded border">
                            <div class="text-xs text-gray-500 uppercase">${key}</div>
                            <div class="font-medium">${value} inches</div>
                        </div>
                    `;
                }
                measurementsHtml += '</div>';
                measurementsDisplay.innerHTML = measurementsHtml;
            } else {
                measurementsDisplay.innerHTML = '<p class="text-gray-500">No measurements recorded for this customer</p>';
            }
        })
        .catch(error => {
            console.error('Error loading customer measurements:', error);
            document.getElementById('measurementsDisplay').innerHTML = '<p class="text-red-500">Error loading measurements</p>';
        });
    }
    
    function showStatusMessage(message, type) {
        const statusElement = document.getElementById('statusMessage');
        statusElement.textContent = message;
        statusElement.classList.remove('hidden', 'bg-green-100', 'text-green-800', 'bg-red-100', 'text-red-800');
        
        if (type === 'success') {
            statusElement.classList.add('bg-green-100', 'text-green-800');
        } else {
            statusElement.classList.add('bg-red-100', 'text-red-800');
        }
        
        statusElement.classList.remove('hidden');
        
        // Auto-hide success messages after 5 seconds
        if (type === 'success') {
            setTimeout(() => {
                statusElement.classList.add('hidden');
            }, 5000);
        }
    }
</script>
{% endblock %}