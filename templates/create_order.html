{% extends 'base.html' %}

{% block title %}Create Order - El Senior Dumingag{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto">
    <div class="bg-white rounded-xl shadow-lg p-8">
        <h1 class="text-2xl font-bold text-gray-800 mb-6 flex items-center">
            <i class="fas fa-shopping-cart text-green-600 mr-2"></i> Create New Order
        </h1>
        
        <div id="statusMessage" class="hidden mb-6 p-4 rounded-lg"></div>
        
        <form id="orderForm" class="space-y-6">
            {% csrf_token %}
            
            <!-- Order Details -->
            <div class="bg-gradient-to-r from-gray-50 to-gray-100 p-6 rounded-xl border border-gray-200 shadow-sm">
                <h2 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
                    <i class="fas fa-info-circle text-blue-600 mr-2"></i> Order Details
                </h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Customer Selection/Creation Section -->
                    <div class="md:col-span-2">
                        <div class="bg-white border border-gray-200 rounded-lg p-4">
                            <div class="flex items-center justify-between mb-4">
                                <label class="block text-sm font-medium text-gray-700">Customer *</label>
                                <div class="flex bg-gray-100 rounded-lg p-1">
                                    <button type="button" id="existingCustomerTab" onclick="switchToExistingCustomer()"
                                        class="px-3 py-1 text-sm font-medium rounded-md bg-white text-gray-900 shadow-sm">
                                        Select Existing
                                    </button>
                                    <button type="button" id="newCustomerTab" onclick="switchToNewCustomer()"
                                        class="px-3 py-1 text-sm font-medium rounded-md text-gray-500 hover:text-gray-900">
                                        Create New
                                    </button>
                                </div>
                            </div>

                            <!-- Existing Customer Selection -->
                            <div id="existingCustomerSection">
                                <select id="customer" name="customer" required
                                    class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500">
                                    <option value="">Select a customer</option>
                                    <!-- Options will be populated dynamically -->
                                </select>
                            </div>

                            <!-- New Customer Creation Form -->
                            <div id="newCustomerSection" class="hidden">
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <label for="new_first_name" class="block text-sm font-medium text-gray-700 mb-1">First Name *</label>
                                        <input type="text" id="new_first_name" name="new_first_name"
                                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500">
                                    </div>
                                    <div>
                                        <label for="new_last_name" class="block text-sm font-medium text-gray-700 mb-1">Last Name *</label>
                                        <input type="text" id="new_last_name" name="new_last_name"
                                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500">
                                    </div>
                                    <div>
                                        <label for="new_email" class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                                        <input type="email" id="new_email" name="new_email"
                                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500">
                                    </div>
                                    <div>
                                        <label for="new_phone_number" class="block text-sm font-medium text-gray-700 mb-1">Phone Number *</label>
                                        <input type="tel" id="new_phone_number" name="new_phone_number"
                                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500">
                                    </div>
                                    <div class="md:col-span-2">
                                        <label for="new_address" class="block text-sm font-medium text-gray-700 mb-1">Address *</label>
                                        <textarea id="new_address" name="new_address" rows="2"
                                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500"></textarea>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div>
                        <label for="category" class="block text-sm font-medium text-gray-700 mb-1">Category *</label>
                        <select id="category" name="category" required
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500">
                            <option value="">Select a category</option>
                            <option value="SCHOOL_UNIFORM">School Uniforms</option>
                            <option value="TEACHERS_UNIFORM">Teachers' Uniforms</option>
                            <option value="OFFICE_ATTIRE">Office Attire</option>
                            <option value="CASUAL_WEAR">Casual Wear</option>
                            <option value="SPECIAL_ORDER">Special Orders</option>
                        </select>
                    </div>
                    <div>
                        <label for="garment_type" class="block text-sm font-medium text-gray-700 mb-1">Garment Type *</label>
                        <select id="garment_type" name="garment_type" required
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500">
                            <option value="">Select a garment type</option>
                            <option value="BLOUSE">Blouse</option>
                            <option value="POLO">Polo</option>
                            <option value="PANTS">Pants</option>
                            <option value="SKIRT">Skirt</option>
                            <option value="DRESS">Dress</option>
                            <option value="JACKET">Jacket</option>
                            <option value="OTHERS">Others</option>
                        </select>
                    </div>
                    <div>
                        <label for="quantity" class="block text-sm font-medium text-gray-700 mb-1">Quantity *</label>
                        <input type="number" id="quantity" name="quantity" min="1" value="1" required
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500">
                    </div>
                    <div>
                        <label for="fabric_type" class="block text-sm font-medium text-gray-700 mb-1">Fabric Type/Details</label>
                        <select id="fabric_type" name="fabric_type" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500">
                            <option value="">Select a fabric</option>
                            <option>Peach Twill</option>
                            <option>Alpha Genna</option>
                            <option>Katrina</option>
                            <option>Gabardine</option>
                            <option>Denim</option>
                            <option>Linen</option>
                            <option>Cotton</option>
                            <option>Satin</option>
                            <option>Silk</option>
                            <option value="__other">Other (specify)</option>
                        </select>
                        <input type="text" id="fabric_type_other" name="fabric_type_other" placeholder="Specify other fabric"
                            class="w-full mt-2 px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500 hidden">
                        <div class="mt-1 text-sm text-gray-500">Select a fabric for faster order creation. Choose "Other" to type a custom fabric.</div>
                    </div>
                    <div class="md:col-span-2">
                         <label class="block text-sm font-medium text-gray-700 mb-3">Accessories (select one or more)</label>
                         <div id="accessories_container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3 p-4 bg-gray-50 rounded-lg border border-gray-300">
                             <p class="col-span-full text-gray-500">Loading accessories...</p>
                         </div>
                         <div class="mt-2 text-sm text-gray-500">Choose accessories to include with this order. Quantities will be deducted from inventory on creation.</div>
                     </div>
                    <div>
                        <label for="color_design_preference" class="block text-sm font-medium text-gray-700 mb-1">Color/Design Preference</label>
                        <textarea id="color_design_preference" name="color_design_preference" rows="2" placeholder="Describe preferred colors, patterns, or design details"
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500"></textarea>
                    </div>
                    <div>
                         <label for="due_date" class="block text-sm font-medium text-gray-700 mb-1">Expected Delivery Date *</label>
                         <input type="date" id="due_date" name="due_date" required
                             class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500">
                     </div>
                    <div>
                        <label for="tailor" class="block text-sm font-medium text-gray-700 mb-1">Assign to Tailor (Optional)</label>
                        <select id="tailor" name="tailor"
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500">
                            <option value="">Do not assign (create pending order)</option>
                            <!-- Tailors will be populated dynamically -->
                        </select>
                        <div class="mt-1 text-sm text-gray-500">If selected, the order will be assigned to this tailor immediately after creation.</div>
                    </div>
                    <!-- Pricing Information -->
                    <div class="md:col-span-2">
                        <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                            <h3 class="text-md font-medium text-blue-800 mb-3">Pricing Information</h3>

                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Garment Price</label>
                                    <div id="garment_price_display" class="text-lg font-semibold text-green-600">₱0.00</div>
                                    <div class="text-xs text-gray-500">Fixed price per garment</div>
                                </div>

                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Total Amount</label>
                                    <div id="total_amount_display" class="text-lg font-semibold text-blue-600">₱0.00</div>
                                    <div class="text-xs text-gray-500">Price × Quantity</div>
                                    <input type="hidden" id="total_amount" name="total_amount" required>
                                </div>

                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Down Payment Required (50%)</label>
                                    <div id="down_payment_display" class="text-lg font-semibold text-red-600">₱0.00</div>
                                    <div class="text-xs text-gray-500">Must be paid before processing</div>
                                </div>
                            </div>

                            <!-- Payment Options -->
                            <div class="mt-4">
                                <label class="block text-sm font-medium text-gray-700 mb-3">Payment Option</label>
                                <div class="space-y-3">
                                    <div class="flex items-center">
                                        <input type="radio" id="down_payment_option" name="payment_option" value="DOWN_PAYMENT" class="h-4 w-4 text-green-600 focus:ring-green-500 border-gray-300" checked>
                                        <label for="down_payment_option" class="ml-3 block text-sm text-gray-700">
                                            <span class="font-medium">Down Payment (50%)</span>
                                            <div class="text-xs text-gray-500">Pay 50% now, remaining balance upon completion</div>
                                        </label>
                                    </div>
                                    <div class="flex items-center">
                                        <input type="radio" id="full_payment_option" name="payment_option" value="FULL_PAYMENT" class="h-4 w-4 text-green-600 focus:ring-green-500 border-gray-300">
                                        <label for="full_payment_option" class="ml-3 block text-sm text-gray-700">
                                            <span class="font-medium">Full Payment</span>
                                            <div class="text-xs text-gray-500">Pay the complete amount now</div>
                                        </label>
                                    </div>
                                </div>
                            </div>

                            <!-- Payment Amount Display -->
                            <div id="payment_amount_display" class="mt-4 p-3 bg-blue-50 border border-blue-200 rounded-md">
                                <div class="flex items-center justify-between">
                                    <span class="text-sm font-medium text-blue-800">Amount to Pay:</span>
                                    <span id="payment_amount_value" class="text-lg font-bold text-blue-600">₱0.00</span>
                                </div>
                                <div id="payment_note" class="text-xs text-blue-600 mt-1">
                                    50% down payment required before processing
                                </div>
                            </div>

                            <div class="mt-3 p-3 bg-blue-50 border border-blue-200 rounded-md">
                                <div class="flex items-center">
                                    <svg class="w-4 h-4 text-blue-600 mr-2" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path>
                                    </svg>
                                    <span class="text-sm text-blue-800">
                                        <strong>New Pricing Model:</strong> Prices are now fixed per garment type.
                                        Fabrics and accessories will be automatically selected from available inventory based on your preferences.
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Detailed Measurements -->
            <div class="bg-gradient-to-r from-gray-50 to-gray-100 p-6 rounded-xl border border-gray-200 shadow-sm">
                <h2 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
                    <i class="fas fa-ruler-vertical text-purple-600 mr-2"></i> Detailed Measurements
                </h2>
                <div class="bg-yellow-50 border-l-4 border-yellow-400 p-4 mb-6 rounded-r-lg">
                    <div class="flex">
                        <div class="flex-shrink-0">
                            <svg class="h-5 w-5 text-yellow-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd" />
                            </svg>
                        </div>
                        <div class="ml-3">
                            <p class="text-sm text-yellow-700">
                                <strong>Note:</strong> Measurement fields will appear based on the selected garment type. All measurements are in inches.
                            </p>
                        </div>
                    </div>
                </div>

                <!-- Customer Basic Measurements Display -->
                <div id="customerMeasurementsDisplay" class="mb-6">
                    <h3 class="text-md font-medium text-gray-700 mb-3">Customer's Basic Measurements</h3>
                    <div id="basicMeasurements" class="text-gray-600">
                        <p>Select a customer to view their basic measurements</p>
                    </div>
                </div>

                <!-- Dynamic Measurement Fields -->
                <div id="measurementFields">
                    <h3 class="text-md font-medium text-gray-700 mb-3">Specific Measurements for This Order</h3>
                    <p class="text-gray-500 mb-4">Select a garment type to see relevant measurement fields</p>

                    <!-- Blouse/Shirt/Top Measurements -->
                    <div id="blouseMeasurements" class="measurement-section hidden">
                        <h4 class="text-sm font-semibold text-gray-600 mb-3">Blouse/Top Measurements</h4>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div>
                                <label for="neck_circumference" class="block text-sm font-medium text-gray-700 mb-1">Neck Circumference (cm)</label>
                                <input type="number" id="neck_circumference" name="neck_circumference" step="0.1"
                                    class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500">
                            </div>
                            <div>
                                <label for="shoulder_width" class="block text-sm font-medium text-gray-700 mb-1">Shoulder Width (cm)</label>
                                <input type="number" id="shoulder_width" name="shoulder_width" step="0.1"
                                    class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500">
                            </div>
                            <div>
                                <label for="chest_bust_circumference" class="block text-sm font-medium text-gray-700 mb-1">Chest/Bust Circumference (cm)</label>
                                <input type="number" id="chest_bust_circumference" name="chest_bust_circumference" step="0.1"
                                    class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500">
                            </div>
                            <div>
                                <label for="upper_bust_circumference" class="block text-sm font-medium text-gray-700 mb-1">Upper Bust Circumference (cm)</label>
                                <input type="number" id="upper_bust_circumference" name="upper_bust_circumference" step="0.1"
                                    class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500">
                            </div>
                            <div>
                                <label for="under_bust_circumference" class="block text-sm font-medium text-gray-700 mb-1">Under Bust Circumference (cm)</label>
                                <input type="number" id="under_bust_circumference" name="under_bust_circumference" step="0.1"
                                    class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500">
                            </div>
                            <div>
                                <label for="waist_circumference" class="block text-sm font-medium text-gray-700 mb-1">Waist Circumference (cm)</label>
                                <input type="number" id="waist_circumference" name="waist_circumference" step="0.1"
                                    class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500">
                            </div>
                            <div>
                                <label for="armhole_circumference" class="block text-sm font-medium text-gray-700 mb-1">Armhole Circumference (cm)</label>
                                <input type="number" id="armhole_circumference" name="armhole_circumference" step="0.1"
                                    class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500">
                            </div>
                            <div>
                                <label for="sleeve_length" class="block text-sm font-medium text-gray-700 mb-1">Sleeve Length</label>
                                <select id="sleeve_length" name="sleeve_length"
                                    class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500">
                                    <option value="">Select sleeve length</option>
                                    <option value="SHORT">Short</option>
                                    <option value="THREE_QUARTER">3/4</option>
                                    <option value="LONG">Long</option>
                                </select>
                            </div>
                            <div>
                                <label for="bicep_circumference" class="block text-sm font-medium text-gray-700 mb-1">Bicep Circumference (cm)</label>
                                <input type="number" id="bicep_circumference" name="bicep_circumference" step="0.1"
                                    class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500">
                            </div>
                            <div>
                                <label for="wrist_circumference" class="block text-sm font-medium text-gray-700 mb-1">Wrist Circumference (cm)</label>
                                <input type="number" id="wrist_circumference" name="wrist_circumference" step="0.1"
                                    class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500">
                            </div>
                            <div>
                                <label for="back_length_nape_to_waist" class="block text-sm font-medium text-gray-700 mb-1">Back Length (Nape to Waist)</label>
                                <input type="number" id="back_length_nape_to_waist" name="back_length_nape_to_waist" step="0.1"
                                    class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500">
                            </div>
                            <div>
                                <label for="blouse_length_shoulder_to_hem" class="block text-sm font-medium text-gray-700 mb-1">Blouse Length (Shoulder to Hem)</label>
                                <input type="number" id="blouse_length_shoulder_to_hem" name="blouse_length_shoulder_to_hem" step="0.1"
                                    class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500">
                            </div>
                        </div>
                    </div>

                    <!-- Pants/Trousers Measurements -->
                    <div id="pantsMeasurements" class="measurement-section hidden">
                        <h4 class="text-sm font-semibold text-gray-600 mb-3">Pants/Trousers Measurements</h4>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div>
                                <label for="waist_circumference_pants" class="block text-sm font-medium text-gray-700 mb-1">Waist Circumference (cm)</label>
                                <input type="number" id="waist_circumference_pants" name="waist_circumference" step="0.1"
                                    class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500">
                            </div>
                            <div>
                                <label for="high_hip_circumference" class="block text-sm font-medium text-gray-700 mb-1">High Hip Circumference (cm)</label>
                                <input type="number" id="high_hip_circumference" name="high_hip_circumference" step="0.1"
                                    class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500">
                            </div>
                            <div>
                                <label for="full_hip_circumference" class="block text-sm font-medium text-gray-700 mb-1">Full Hip Circumference (cm)</label>
                                <input type="number" id="full_hip_circumference" name="full_hip_circumference" step="0.1"
                                    class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500">
                            </div>
                            <div>
                                <label for="thigh_circumference" class="block text-sm font-medium text-gray-700 mb-1">Thigh Circumference (cm)</label>
                                <input type="number" id="thigh_circumference" name="thigh_circumference" step="0.1"
                                    class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500">
                            </div>
                            <div>
                                <label for="knee_circumference" class="block text-sm font-medium text-gray-700 mb-1">Knee Circumference (cm)</label>
                                <input type="number" id="knee_circumference" name="knee_circumference" step="0.1"
                                    class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500">
                            </div>
                            <div>
                                <label for="calf_circumference" class="block text-sm font-medium text-gray-700 mb-1">Calf Circumference (cm)</label>
                                <input type="number" id="calf_circumference" name="calf_circumference" step="0.1"
                                    class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500">
                            </div>
                            <div>
                                <label for="ankle_circumference" class="block text-sm font-medium text-gray-700 mb-1">Ankle Circumference (cm)</label>
                                <input type="number" id="ankle_circumference" name="ankle_circumference" step="0.1"
                                    class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500">
                            </div>
                            <div>
                                <label for="inseam_crotch_to_ankle" class="block text-sm font-medium text-gray-700 mb-1">Inseam (Crotch to Ankle) (cm)</label>
                                <input type="number" id="inseam_crotch_to_ankle" name="inseam_crotch_to_ankle" step="0.1"
                                    class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500">
                            </div>
                            <div>
                                <label for="outseam_waist_to_ankle" class="block text-sm font-medium text-gray-700 mb-1">Outseam (Waist to Ankle) (cm)</label>
                                <input type="number" id="outseam_waist_to_ankle" name="outseam_waist_to_ankle" step="0.1"
                                    class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500">
                            </div>
                            <div>
                                <label for="front_rise" class="block text-sm font-medium text-gray-700 mb-1">Front Rise (cm)</label>
                                <input type="number" id="front_rise" name="front_rise" step="0.1"
                                    class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500">
                            </div>
                            <div>
                                <label for="back_rise" class="block text-sm font-medium text-gray-700 mb-1">Back Rise (cm)</label>
                                <input type="number" id="back_rise" name="back_rise" step="0.1"
                                    class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500">
                            </div>
                        </div>
                    </div>

                    <!-- Skirt/Dress Measurements -->
                    <div id="skirtDressMeasurements" class="measurement-section hidden">
                        <h4 class="text-sm font-semibold text-gray-600 mb-3">Skirt/Dress Measurements</h4>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div>
                                <label for="waist_circumference_skirt" class="block text-sm font-medium text-gray-700 mb-1">Waist Circumference (cm)</label>
                                <input type="number" id="waist_circumference_skirt" name="waist_circumference" step="0.1"
                                    class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500">
                            </div>
                            <div>
                                <label for="high_hip_circumference_skirt" class="block text-sm font-medium text-gray-700 mb-1">High Hip Circumference (cm)</label>
                                <input type="number" id="high_hip_circumference_skirt" name="high_hip_circumference" step="0.1"
                                    class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500">
                            </div>
                            <div>
                                <label for="full_hip_circumference_skirt" class="block text-sm font-medium text-gray-700 mb-1">Full Hip Circumference (cm)</label>
                                <input type="number" id="full_hip_circumference_skirt" name="full_hip_circumference" step="0.1"
                                    class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500">
                            </div>
                            <div>
                                <label for="skirt_dress_length" class="block text-sm font-medium text-gray-700 mb-1">Skirt/Dress Length (cm)</label>
                                <input type="number" id="skirt_dress_length" name="skirt_dress_length" step="0.1"
                                    class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500">
                            </div>
                            <div>
                                <label for="hem_circumference" class="block text-sm font-medium text-gray-700 mb-1">Hem Circumference (optional) (cm)</label>
                                <input type="number" id="hem_circumference" name="hem_circumference" step="0.1"
                                    class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500">
                            </div>
                        </div>
                    </div>

                    <!-- Jacket/Coat Measurements -->
                    <div id="jacketMeasurements" class="measurement-section hidden">
                        <h4 class="text-sm font-semibold text-gray-600 mb-3">Jacket/Coat Measurements</h4>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div>
                                <label for="neck_circumference_jacket" class="block text-sm font-medium text-gray-700 mb-1">Neck Circumference (cm)</label>
                                <input type="number" id="neck_circumference_jacket" name="neck_circumference" step="0.1"
                                    class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500">
                            </div>
                            <div>
                                <label for="shoulder_width_jacket" class="block text-sm font-medium text-gray-700 mb-1">Shoulder Width (cm)</label>
                                <input type="number" id="shoulder_width_jacket" name="shoulder_width" step="0.1"
                                    class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500">
                            </div>
                            <div>
                                <label for="chest_bust_circumference_jacket" class="block text-sm font-medium text-gray-700 mb-1">Chest/Bust Circumference (cm)</label>
                                <input type="number" id="chest_bust_circumference_jacket" name="chest_bust_circumference" step="0.1"
                                    class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500">
                            </div>
                            <div>
                                <label for="waist_circumference_jacket" class="block text-sm font-medium text-gray-700 mb-1">Waist Circumference (cm)</label>
                                <input type="number" id="waist_circumference_jacket" name="waist_circumference" step="0.1"
                                    class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500">
                            </div>
                            <div>
                                <label for="full_hip_circumference_jacket" class="block text-sm font-medium text-gray-700 mb-1">Hip Circumference (cm)</label>
                                <input type="number" id="full_hip_circumference_jacket" name="full_hip_circumference" step="0.1"
                                    class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500">
                            </div>
                            <div>
                                <label for="sleeve_length_jacket" class="block text-sm font-medium text-gray-700 mb-1">Sleeve Length</label>
                                <select id="sleeve_length_jacket" name="sleeve_length"
                                    class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500">
                                    <option value="">Select sleeve length</option>
                                    <option value="SHORT">Short</option>
                                    <option value="THREE_QUARTER">3/4</option>
                                    <option value="LONG">Long</option>
                                </select>
                            </div>
                            <div>
                                <label for="bicep_circumference_jacket" class="block text-sm font-medium text-gray-700 mb-1">Bicep Circumference (cm)</label>
                                <input type="number" id="bicep_circumference_jacket" name="bicep_circumference" step="0.1"
                                    class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500">
                            </div>
                            <div>
                                <label for="wrist_circumference_jacket" class="block text-sm font-medium text-gray-700 mb-1">Wrist Circumference (cm)</label>
                                <input type="number" id="wrist_circumference_jacket" name="wrist_circumference" step="0.1"
                                    class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500">
                            </div>
                            <div>
                                <label for="jacket_length_shoulder_to_hem" class="block text-sm font-medium text-gray-700 mb-1">Jacket Length (Shoulder to Hem) (cm)</label>
                                <input type="number" id="jacket_length_shoulder_to_hem" name="jacket_length_shoulder_to_hem" step="0.1"
                                    class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500">
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="flex justify-end space-x-4">
                <button type="button" id="cancelBtn"
                    class="px-6 py-2 bg-gray-300 text-gray-700 font-medium rounded-lg hover:bg-gray-400 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500 transition-colors">
                    Cancel
                </button>
                <button type="submit" 
                    class="px-6 py-2 bg-green-600 text-white font-medium rounded-lg hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 transition-colors">
                    Create Order
                </button>
            </div>
        </form>
    </div>
</div>

    <!-- Global modal for displaying reports and errors -->
    <div id="globalModal" class="fixed inset-0 hidden items-center justify-center bg-black bg-opacity-50 z-50">
        <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full p-6 mx-4">
            <div class="flex justify-between items-center mb-4">
                <h3 id="globalModalTitle" class="text-lg font-semibold">Modal Title</h3>
                <button id="globalModalClose" class="text-gray-500 hover:text-gray-900">✕</button>
            </div>
            <div id="globalModalBody" class="text-sm text-gray-800 whitespace-pre-wrap"></div>
            <div class="mt-4 text-right">
                <button id="globalModalOk" class="px-4 py-2 bg-green-600 text-white rounded-lg">OK</button>
            </div>
        </div>
    </div>

<script>
    // Get CSRF token from the form and store in session
    const csrfTokenElement = document.querySelector('[name="csrfmiddlewaretoken"]');
    const csrfToken = csrfTokenElement ? csrfTokenElement.value : '';
    // Max number of accessories allowed to be selected in the UI
    const MAX_ACCESSORIES_SELECT = 3;
    
    // Store token in sessionStorage for other requests
    if (csrfToken) {
        sessionStorage.setItem('csrfToken', csrfToken);
    }
    
    // Update payment amount display based on selected option
    function updatePaymentAmountDisplay() {
        const totalAmountText = document.getElementById('total_amount_display').textContent;
        const totalAmount = parseFloat(totalAmountText.replace('₱', '').replace(',', '')) || 0;
        const paymentOption = document.querySelector('input[name="payment_option"]:checked')?.value || 'DOWN_PAYMENT';

        const paymentAmountElement = document.getElementById('payment_amount_value');
        const paymentNoteElement = document.getElementById('payment_note');

        if (paymentOption === 'FULL_PAYMENT') {
            paymentAmountElement.textContent = PricingManager.formatCurrency(totalAmount);
            paymentNoteElement.textContent = 'Full payment - order will be processed immediately';
        } else {
            const downPayment = PricingManager.calculateDownPayment(totalAmount);
            paymentAmountElement.textContent = PricingManager.formatCurrency(downPayment);
            paymentNoteElement.textContent = '50% down payment required before processing';
        }
    }

    // Fallback tab switcher functions exposed on window so onclick attributes work
    // These are defensive: they perform the same toggling as initializeCustomerTabs
    window.switchToExistingCustomer = function() {
        try {
            const existingTab = document.getElementById('existingCustomerTab');
            const newTab = document.getElementById('newCustomerTab');
            const existingSection = document.getElementById('existingCustomerSection');
            const newSection = document.getElementById('newCustomerSection');
            const customerSelect = document.getElementById('customer');

            if (!existingTab || !newTab || !existingSection || !newSection || !customerSelect) return;

            existingTab.classList.add('bg-white', 'text-gray-900', 'shadow-sm');
            existingTab.classList.remove('text-gray-500');
            newTab.classList.remove('bg-white', 'text-gray-900', 'shadow-sm');
            newTab.classList.add('text-gray-500');

            existingSection.classList.remove('hidden');
            newSection.classList.add('hidden');

            customerSelect.required = true;
            clearNewCustomerFields();
            setNewCustomerFieldsRequired(false);
        } catch (err) {
            console.error('switchToExistingCustomer error', err);
        }
    };

    window.switchToNewCustomer = function() {
        try {
            const existingTab = document.getElementById('existingCustomerTab');
            const newTab = document.getElementById('newCustomerTab');
            const existingSection = document.getElementById('existingCustomerSection');
            const newSection = document.getElementById('newCustomerSection');
            const customerSelect = document.getElementById('customer');

            if (!existingTab || !newTab || !existingSection || !newSection || !customerSelect) return;

            newTab.classList.add('bg-white', 'text-gray-900', 'shadow-sm');
            newTab.classList.remove('text-gray-500');
            existingTab.classList.remove('bg-white', 'text-gray-900', 'shadow-sm');
            existingTab.classList.add('text-gray-500');

            newSection.classList.remove('hidden');
            existingSection.classList.add('hidden');

            customerSelect.required = false;
            customerSelect.value = '';
            setNewCustomerFieldsRequired(true);

            const basicMeasurementsEl = document.getElementById('basicMeasurements');
            if (basicMeasurementsEl) {
                basicMeasurementsEl.innerHTML = '<p>Customer measurements will be available after creating the new customer</p>';
            }
        } catch (err) {
            console.error('switchToNewCustomer error', err);
        }
    };

    // Load customers and tailors when page loads
    document.addEventListener('DOMContentLoaded', function() {
        // Set default expected delivery date (7 days from now)
        const today = new Date();
        const defaultDueDate = new Date(today.getTime() + (7 * 24 * 60 * 60 * 1000));
        document.getElementById('due_date').value = defaultDueDate.toISOString().split('T')[0];

        // Set minimum expected delivery date to today
        document.getElementById('due_date').min = today.toISOString().split('T')[0];

        // Initialize customer section tabs
        initializeCustomerTabs();

        // Add phone number validation for new customer
        addNewCustomerValidation();

        // Initialize pricing display
        updatePricingDisplay();

        // Initialize payment amount display
        updatePaymentAmountDisplay();

        // Add event listeners for payment option changes
        document.querySelectorAll('input[name="payment_option"]').forEach(radio => {
            radio.addEventListener('change', updatePaymentAmountDisplay);
        });

        // Add event listeners for pricing updates (guard in case elements are missing)
        const garmentTypeEl = document.getElementById('garment_type');
        if (garmentTypeEl) {
            garmentTypeEl.addEventListener('change', function() {
                updatePricingDisplay();
                updatePaymentAmountDisplay();
            });
        }
        const quantityEl = document.getElementById('quantity');
        if (quantityEl) {
            quantityEl.addEventListener('change', function() {
                updatePricingDisplay();
                updatePaymentAmountDisplay();
            });
        }

        // Load customers with callback to handle pre-selected customer
        loadCustomersWithCallback(function(customerId) {
            if (customerId) {
                document.getElementById('customer').value = customerId;
                loadCustomerMeasurements(customerId);
            }
        });
        
        loadTailors(); // Load tailors for assignment (without filter initially)
        loadFabrics(); // Load fabrics for selection
        loadAccessories(); // Load accessories for selection
    });
    
    // Handle customer selection to load measurements (guard if element missing)
    const customerEl = document.getElementById('customer');
    if (customerEl) {
        customerEl.addEventListener('change', function() {
            // Clear error styling
            this.classList.remove('border-red-500');

            const customerId = this.value;
            if (customerId) {
                loadCustomerMeasurements(customerId);

                // Auto-populate measurements if garment type is already selected
                const garmentTypeEl2 = document.getElementById('garment_type');
                const garmentType = garmentTypeEl2 ? garmentTypeEl2.value : null;
                if (garmentType) {
                    // Small delay to ensure measurements are loaded first
                    setTimeout(() => {
                        if (window.customerMeasurements && Object.keys(window.customerMeasurements).length > 0) {
                            autoPopulateOrderMeasurements();
                        }
                    }, 500);
                }
            } else {
                const basicMeasurementsEl = document.getElementById('basicMeasurements');
                if (basicMeasurementsEl) {
                    basicMeasurementsEl.innerHTML = '<p>Select a customer to view their basic measurements</p>';
                }
                window.customerMeasurements = {};
            }
        });
    }

    // Handle garment type selection to show relevant measurement fields and update pricing
    document.getElementById('garment_type').addEventListener('change', function() {
         // Clear error styling
         this.classList.remove('border-red-500');

         const garmentType = this.value;
         showMeasurementFields(garmentType);
         updatePricingDisplay();
         
         // Load tailors filtered by garment type
         loadTailors(garmentType);

         // Auto-populate measurements if customer is selected and has measurements
         const customerId = document.getElementById('customer').value;
         if (customerId && window.customerMeasurements && Object.keys(window.customerMeasurements).length > 0) {
             // Small delay to ensure measurement fields are shown first
             setTimeout(() => {
                 autoPopulateOrderMeasurements();
             }, 100);
         }
         // Filter accessories to show only those relevant to this garment type
         try {
             filterAccessoriesByGarment(garmentType);
         } catch (e) {
             // ignore
         }
     });

    // Fabric type select: show/hide 'other' text input when appropriate
    const fabricSelect = document.getElementById('fabric_type');
    const fabricOther = document.getElementById('fabric_type_other');
    if (fabricSelect) {
        fabricSelect.addEventListener('change', function() {
            if (this.value === '__other') {
                if (fabricOther) fabricOther.classList.remove('hidden');
                // set required to ensure user supplies the other fabric
                if (fabricOther) fabricOther.setAttribute('required', 'required');
            } else {
                if (fabricOther) {
                    fabricOther.classList.add('hidden');
                    fabricOther.removeAttribute('required');
                    fabricOther.value = '';
                }
            }
        });
    }

    // Handle quantity change to update total amount
    document.getElementById('quantity').addEventListener('change', function() {
        // Clear error styling
        this.classList.remove('border-red-500');

        updatePricingDisplay();
    });
    
    // Handle form submission
    document.getElementById('orderForm').addEventListener('submit', async function(e) {
        e.preventDefault();

        // Check if we're creating a new customer or using existing
        const isNewCustomer = !document.getElementById('newCustomerSection').classList.contains('hidden');
        let customerId = null;

        if (isNewCustomer) {
            // Create new customer first
            const newCustomer = await createNewCustomer();
            if (!newCustomer) {
                return; // Error creating customer, stop here
            }
            customerId = newCustomer.id;
        } else {
            // Use existing customer
            customerId = document.getElementById('customer').value;
            if (!customerId) {
                showStatusMessage('Please select a customer', 'error');
                return;
            }
        }

        // Validate other form fields
        const category = document.getElementById('category').value;
        const garmentType = document.getElementById('garment_type').value;
        const quantity = document.getElementById('quantity').value;
        const dueDate = document.getElementById('due_date').value;
        const totalAmount = document.getElementById('total_amount').value;

        if (!category) {
            showStatusMessage('Please select a category', 'error');
            return;
        }

        if (!garmentType) {
            showStatusMessage('Please select a garment type', 'error');
            return;
        }

        if (!quantity || quantity <= 0) {
            showStatusMessage('Quantity must be greater than zero', 'error');
            return;
        }



        if (!dueDate) {
             showStatusMessage('Please select an expected delivery date', 'error');
             return;
         }

        // Total amount is automatically calculated, just ensure it's valid
        if (!totalAmount || totalAmount <= 0) {
            showStatusMessage('Please select a garment type and quantity to calculate pricing', 'error');
            return;
        }

        // Collect measurement data based on garment type
        const measurementData = collectMeasurementData(garmentType);

        // Get payment option
        const paymentOption = document.querySelector('input[name="payment_option"]:checked').value;

        // Collect form data
        const orderData = {
            customer_id: customerId,
            category: category,
            garment_type: garmentType,
            quantity: parseInt(quantity),
            fabric_type: (function(){
                const sel = document.getElementById('fabric_type');
                const other = document.getElementById('fabric_type_other');
                if (!sel) return '';
                if (sel.value === '__other') {
                    return other ? other.value.trim() : '';
                }
                // If fabrics were loaded from API, sel.value will be the fabric id; use the display text for fabric_type
                try {
                    const idx = sel.selectedIndex;
                    return (idx >= 0 && sel.options[idx]) ? sel.options[idx].text : sel.value;
                } catch (e) {
                    return sel.value;
                }
            })(),
            fabric_id: (function(){
                const sel = document.getElementById('fabric_type');
                if (!sel) return null;
                if (sel.value === '__other' || sel.value === '') return null;
                // If value is numeric id, return it as int, otherwise null
                const v = sel.value;
                return isNaN(Number(v)) ? null : Number(v);
            })(),
            accessories_ids: (function(){
                const sel = document.getElementById('accessories_select');
                if (!sel) return [];
                return Array.from(sel.selectedOptions).map(o => Number(o.value));
            })(),
            color_design_preference: document.getElementById('color_design_preference').value,
            due_date: dueDate,
            total_amount: totalAmount,
            status: 'PENDING',
            payment_option: paymentOption,
            ...measurementData
        };
        
        // Enforce accessory selection limit
        const selectedAccessories = orderData.accessories_ids || [];
        if (selectedAccessories.length > MAX_ACCESSORIES_SELECT) {
            showModal('Accessory selection limit', `Please select at most ${MAX_ACCESSORIES_SELECT} accessories.`);
            return;
        }

        // Debug log
        console.log('Submitting order data:', orderData);
        
        // Get selected tailor (if any)
        const tailorId = document.getElementById('tailor').value;
        
        // Submit the data
        // Build headers and include Authorization only when a token exists to avoid sending a blank Token header
        const createOrderHeaders = {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken
        };
        const createAuthToken = localStorage.getItem('authToken') || sessionStorage.getItem('authToken');
        if (createAuthToken) {
            createOrderHeaders['Authorization'] = 'Token ' + createAuthToken;
        }

        fetch('/api/admin/orders/', {
            method: 'POST',
            headers: createOrderHeaders,
            credentials: 'include',
            body: JSON.stringify(orderData)
        })
        .then(response => {
            // Debug logging
            console.log('Server response status:', response.status);
            console.log('Response headers:', response.headers);
            
            if (!response.ok) {
                if (response.headers.get('content-type')?.includes('text/html')) {
                    // Server returned HTML instead of JSON (likely a login page)
                    console.error('Authentication error - received HTML response');
                    throw new Error('Authentication error. Please refresh the page and try again.');
                }
                return response.json().then(errors => {
                    console.error('Error response JSON:', errors);
                    throw new Error(JSON.stringify(errors));
                });
            }
            return response.json();
        })
        .then(data => {
            // Handle both paginated and non-paginated responses
            const order = data.results || data;
            
            // If a tailor was selected, assign the order to that tailor
            if (tailorId) {
                return fetch('/api/admin/assign-order/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Token ' + (localStorage.getItem('authToken') || sessionStorage.getItem('authToken') || ''),
                        'X-CSRFToken': csrfToken
                    },
                    credentials: 'include',
                    body: JSON.stringify({
                        order_id: order.id,
                        tailor_id: tailorId
                    })
                })
                .then(response => {
                    if (!response.ok) {
                        if (response.headers.get('content-type')?.includes('text/html')) {
                            // Server returned HTML instead of JSON (likely a login page)
                            console.error('Authentication error - received HTML response');
                            throw new Error('Authentication error. Please refresh the page and try again.');
                        }
                        return response.json().then(errors => {
                            throw new Error(JSON.stringify(errors));
                        });
                    }
                    return response.json();
                })
                .then(assignData => {
                    const managePaymentsUrl = '{% url "etailoring:manage_payments" %}';
                    let message = 'Order created and assigned to tailor successfully!';
                    if (order && order.down_payment_amount && Number(order.down_payment_amount) > 0) {
                        const paidText = order.down_payment_status === 'PAID' ? 'paid' : 'pending';
                        message = `Order created. Down payment: ₱${Number(order.down_payment_amount).toFixed(2)} (${paidText}). <a href="${managePaymentsUrl}" class="font-medium underline">Manage Payments</a>`;
                    }
                    showStatusMessage(message, 'success');
                    return order; // Return original order data
                });
            } else {
                const managePaymentsUrl = '{% url "etailoring:manage_payments" %}';
                if (order && order.down_payment_amount && Number(order.down_payment_amount) > 0) {
                    const paidText = order.down_payment_status === 'PAID' ? 'paid' : 'pending';
                    const message = `Order created. Down payment: ₱${Number(order.down_payment_amount).toFixed(2)} (${paidText}). <a href="${managePaymentsUrl}" class="font-medium underline">Manage Payments</a>`;
                    showStatusMessage(message, 'success');
                } else {
                    showStatusMessage('Order created successfully!', 'success');
                }
                return order;
            }
        })
        .then(order => {
            // Reset the form
            document.getElementById('orderForm').reset();
            const basicMeasurementsEl = document.getElementById('basicMeasurements');
            if (basicMeasurementsEl) {
                basicMeasurementsEl.innerHTML = '<p>Select a customer to view their basic measurements</p>';
            }

            // After creating the order, automatically process the down payment if applicable
            // and provide a printable receipt for the created order.
            (async function autoHandlePostCreate(createdOrder, paymentOption) {
                try {
                    const orderId = createdOrder.id;
                    const downAmount = Number(createdOrder.down_payment_amount || 0);

                    // Only process a down payment if the user did NOT select Full Payment.
                    // When Full Payment is selected we will process the full payment instead
                    // and remove the down payment so receipts don't show it.
                    if (paymentOption !== 'FULL_PAYMENT' && downAmount > 0 && createdOrder.down_payment_status !== 'PAID') {
                        const authToken = localStorage.getItem('authToken') || sessionStorage.getItem('authToken');
                        const payHeaders = {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': csrfToken
                        };
                        if (authToken) payHeaders['Authorization'] = 'Token ' + authToken;

                        const resp = await fetch(`/api/admin/orders/${orderId}/process-payment/`, {
                            method: 'POST',
                            headers: payHeaders,
                            credentials: 'include',
                            body: JSON.stringify({ payment_type: 'DOWN_PAYMENT' })
                        });

                        if (resp.ok) {
                            const paymentResult = await resp.json();
                            console.log('Down payment processed:', paymentResult);
                            // Update createdOrder object to reflect paid down payment
                            createdOrder.down_payment_status = paymentResult.down_payment_status || 'PAID';
                            createdOrder.payment_status = paymentResult.payment_status || createdOrder.payment_status;
                        } else {
                            console.warn('Down payment processing failed, server responded with', resp.status);
                        }
                    }

                    // If the user selected Full Payment when creating the order, process it immediately
                    if (paymentOption === 'FULL_PAYMENT') {
                        try {
                            const authToken2 = localStorage.getItem('authToken') || sessionStorage.getItem('authToken');
                            const payHeaders2 = {
                                'Content-Type': 'application/json',
                                'X-CSRFToken': csrfToken
                            };
                            if (authToken2) payHeaders2['Authorization'] = 'Token ' + authToken2;

                            const respFull = await fetch(`/api/admin/orders/${orderId}/process-payment/`, {
                                method: 'POST',
                                headers: payHeaders2,
                                credentials: 'include',
                                body: JSON.stringify({ payment_type: 'FULL_PAYMENT' })
                            });

                            if (respFull.ok) {
                                const paymentResultFull = await respFull.json();
                                console.log('Full payment processed:', paymentResultFull);
                                // Update createdOrder to reflect full payment so receipt shows zero balance
                                createdOrder.payment_status = paymentResultFull.payment_status || 'PAID';
                                createdOrder.down_payment_status = 'PAID';
                                // Remove the down payment entry when full payment was chosen so
                                // the receipt does not show a separate down payment amount.
                                createdOrder.down_payment_amount = 0;
                                createdOrder.remaining_balance = 0;
                            } else {
                                console.warn('Full payment processing failed, server responded with', respFull.status);
                            }
                        } catch (err) {
                            console.error('Error processing full payment:', err);
                        }
                    }

                    // Build a simple printable receipt and expose a Print button in the UI
                    const receiptBtnId = 'printReceiptBtn';
                    // Remove old button if exists
                    const oldBtn = document.getElementById(receiptBtnId);
                    if (oldBtn) oldBtn.remove();

                    const receiptBtn = document.createElement('button');
                    receiptBtn.id = receiptBtnId;
                    receiptBtn.className = 'mt-4 px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700';
                    receiptBtn.textContent = 'Print Receipt';
                    receiptBtn.addEventListener('click', function() {
                        printOrderReceipt(createdOrder);
                    });

                    // Also add a Manage Payments link/button next to receipt
                    const manageLink = document.createElement('a');
                    manageLink.href = '{% url "etailoring:manage_payments" %}';
                    manageLink.className = 'ml-3 mt-4 inline-block px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700';
                    manageLink.textContent = 'Go to Manage Payments';

                    // Show both buttons below the status message
                    const statusEl = document.getElementById('statusMessage');
                    if (statusEl) {
                        statusEl.appendChild(receiptBtn);
                        statusEl.appendChild(manageLink);
                    }

                    // Auto-open print dialog immediately (user requested popup)
                    try {
                        printOrderReceipt(createdOrder);
                    } catch (err) {
                        console.warn('Auto print failed (possibly blocked by popup blocker):', err);
                    }
                } catch (err) {
                    console.error('Error while auto-processing down payment or preparing receipt:', err);
                }
            })(order, paymentOption);

            // Redirect to admin dashboard after a short delay (keep as fallback)
            setTimeout(() => {
                window.location.href = '{% url "etailoring:admin_dashboard" %}';
            }, 4000);
        })
        .catch(error => {
            console.error('Error:', error);
            
            // Better error handling with debugging information
            let errorMessage = 'Error creating order';
            if (error.message) {
                try {
                    // Try to parse the error message as JSON
                    const errorObj = JSON.parse(error.message);
                    
                    // Format field-specific errors nicely
                    if (typeof errorObj === 'object') {
                        const fieldErrors = [];
                        for (const [field, errors] of Object.entries(errorObj)) {
                            // Format field name nicer
                            let fieldName = field.replace('_', ' ');
                            fieldName = fieldName.charAt(0).toUpperCase() + fieldName.slice(1);
                            
                            if (Array.isArray(errors)) {
                                fieldErrors.push(`${fieldName}: ${errors.join(', ')}`);
                            } else {
                                fieldErrors.push(`${fieldName}: ${errors}`);
                            }
                        }
                        
                        if (fieldErrors.length > 0) {
                            errorMessage = fieldErrors.join('\n');
                        } else {
                            errorMessage = JSON.stringify(errorObj);
                        }
                    } else {
                        errorMessage = JSON.stringify(errorObj);
                    }
                } catch (e) {
                    // If not JSON, use the error message directly
                    errorMessage = error.message;
                    
                    // Check specifically for customer_id errors
                    if (error.message.includes('customer_id') || error.message.includes('NOT NULL constraint failed')) {
                        errorMessage = 'Please select a customer';
                        document.getElementById('customer').classList.add('border-red-500');
                    }
                    
                    // Check for inventory errors
                    if (error.message.includes('Insufficient')) {
                        errorMessage = error.message;
                    }
                }
            }
            
            // Check for authentication issues
            if (error.message && error.message.includes('<!DOCTYPE')) {
                errorMessage = 'Authentication error. Please refresh the page and try again.';
                console.log('Received HTML instead of JSON. This usually indicates an authentication or session issue.');
            }
            
            showStatusMessage(errorMessage, 'error');
        });
    });
    
    // Handle cancel button
    document.getElementById('cancelBtn').addEventListener('click', function() {
        if (confirm('Are you sure you want to cancel? Any entered information will be lost.')) {
            window.location.href = '{% url "etailoring:admin_dashboard" %}';
        }
    });

    // Show/hide measurement fields based on garment type
    function showMeasurementFields(garmentType) {
        // Hide all measurement sections
        const measurementSections = document.querySelectorAll('.measurement-section');
        measurementSections.forEach(section => {
            section.classList.add('hidden');
        });

        // Show relevant measurement sections based on garment type
        switch(garmentType) {
            case 'BLOUSE':
                document.getElementById('blouseMeasurements').classList.remove('hidden');
                break;
            case 'PANTS':
                document.getElementById('pantsMeasurements').classList.remove('hidden');
                break;
            case 'SKIRT':
                document.getElementById('skirtDressMeasurements').classList.remove('hidden');
                break;
            case 'DRESS':
                document.getElementById('blouseMeasurements').classList.remove('hidden');
                document.getElementById('skirtDressMeasurements').classList.remove('hidden');
                break;
            case 'JACKET':
                document.getElementById('jacketMeasurements').classList.remove('hidden');
                break;
            default:
                // For 'OTHERS' or no selection, show no specific measurements
                break;
        }
    }

    // Collect measurement data based on garment type
    function collectMeasurementData(garmentType) {
        const measurements = {};

        // Helper function to get value if element exists and has value
        function getValue(id) {
            const element = document.getElementById(id);
            return element && element.value ? parseFloat(element.value) : null;
        }

        // Collect measurements based on garment type
        if (garmentType === 'BLOUSE' || garmentType === 'DRESS') {
            measurements.neck_circumference = getValue('neck_circumference');
            measurements.shoulder_width = getValue('shoulder_width');
            measurements.chest_bust_circumference = getValue('chest_bust_circumference');
            measurements.upper_bust_circumference = getValue('upper_bust_circumference');
            measurements.under_bust_circumference = getValue('under_bust_circumference');
            measurements.waist_circumference = getValue('waist_circumference');
            measurements.armhole_circumference = getValue('armhole_circumference');
            measurements.bicep_circumference = getValue('bicep_circumference');
            measurements.wrist_circumference = getValue('wrist_circumference');
            measurements.back_length_nape_to_waist = getValue('back_length_nape_to_waist');
            measurements.blouse_length_shoulder_to_hem = getValue('blouse_length_shoulder_to_hem');

            // Handle sleeve length dropdown
            const sleeveLength = document.getElementById('sleeve_length');
            if (sleeveLength && sleeveLength.value) {
                measurements.sleeve_length = sleeveLength.value;
            }
        }

        if (garmentType === 'PANTS') {
            measurements.waist_circumference = getValue('waist_circumference_pants');
            measurements.high_hip_circumference = getValue('high_hip_circumference');
            measurements.full_hip_circumference = getValue('full_hip_circumference');
            measurements.thigh_circumference = getValue('thigh_circumference');
            measurements.knee_circumference = getValue('knee_circumference');
            measurements.calf_circumference = getValue('calf_circumference');
            measurements.ankle_circumference = getValue('ankle_circumference');
            measurements.inseam_crotch_to_ankle = getValue('inseam_crotch_to_ankle');
            measurements.outseam_waist_to_ankle = getValue('outseam_waist_to_ankle');
            measurements.front_rise = getValue('front_rise');
            measurements.back_rise = getValue('back_rise');
        }

        if (garmentType === 'SKIRT' || garmentType === 'DRESS') {
            measurements.waist_circumference = getValue('waist_circumference_skirt');
            measurements.high_hip_circumference = getValue('high_hip_circumference_skirt');
            measurements.full_hip_circumference = getValue('full_hip_circumference_skirt');
            measurements.skirt_dress_length = getValue('skirt_dress_length');
            measurements.hem_circumference = getValue('hem_circumference');
        }

        if (garmentType === 'JACKET') {
            measurements.neck_circumference = getValue('neck_circumference_jacket');
            measurements.shoulder_width = getValue('shoulder_width_jacket');
            measurements.chest_bust_circumference = getValue('chest_bust_circumference_jacket');
            measurements.waist_circumference = getValue('waist_circumference_jacket');
            measurements.full_hip_circumference = getValue('full_hip_circumference_jacket');
            measurements.bicep_circumference = getValue('bicep_circumference_jacket');
            measurements.wrist_circumference = getValue('wrist_circumference_jacket');
            measurements.jacket_length_shoulder_to_hem = getValue('jacket_length_shoulder_to_hem');

            // Handle sleeve length dropdown for jacket
            const sleeveLength = document.getElementById('sleeve_length_jacket');
            if (sleeveLength && sleeveLength.value) {
                measurements.sleeve_length = sleeveLength.value;
            }
        }

        // Filter out null values
        const filteredMeasurements = {};
        for (const [key, value] of Object.entries(measurements)) {
            if (value !== null && value !== undefined) {
                filteredMeasurements[key] = value;
            }
        }

        return filteredMeasurements;
    }

    // Initialize customer section tabs
    function initializeCustomerTabs() {
        const existingTab = document.getElementById('existingCustomerTab');
        const newTab = document.getElementById('newCustomerTab');
        const existingSection = document.getElementById('existingCustomerSection');
        const newSection = document.getElementById('newCustomerSection');
        const customerSelect = document.getElementById('customer');

        // Check if all required elements exist
        if (!existingTab || !newTab || !existingSection || !newSection || !customerSelect) {
            console.error('Customer tab elements not found. Tab functionality will not work.');
            return;
        }

        // Tab click handlers
        existingTab.addEventListener('click', function() {
            // Switch to existing customer tab
            existingTab.classList.add('bg-white', 'text-gray-900', 'shadow-sm');
            existingTab.classList.remove('text-gray-500');
            newTab.classList.remove('bg-white', 'text-gray-900', 'shadow-sm');
            newTab.classList.add('text-gray-500');

            // Show/hide sections
            existingSection.classList.remove('hidden');
            newSection.classList.add('hidden');

            // Update form validation
            customerSelect.required = true;
            clearNewCustomerFields();
            setNewCustomerFieldsRequired(false);
        });

        newTab.addEventListener('click', function() {
            // Switch to new customer tab
            newTab.classList.add('bg-white', 'text-gray-900', 'shadow-sm');
            newTab.classList.remove('text-gray-500');
            existingTab.classList.remove('bg-white', 'text-gray-900', 'shadow-sm');
            existingTab.classList.add('text-gray-500');

            // Show/hide sections
            newSection.classList.remove('hidden');
            existingSection.classList.add('hidden');

            // Update form validation
            customerSelect.required = false;
            customerSelect.value = '';
            setNewCustomerFieldsRequired(true);

            // Clear customer measurements display
            const basicMeasurementsEl = document.getElementById('basicMeasurements');
            if (basicMeasurementsEl) {
                basicMeasurementsEl.innerHTML = '<p>Customer measurements will be available after creating the new customer</p>';
            }
        });
    }

    // Helper function to clear new customer fields
    function clearNewCustomerFields() {
        const fields = ['new_first_name', 'new_last_name', 'new_email', 'new_phone_number', 'new_address'];
        fields.forEach(fieldId => {
            const field = document.getElementById(fieldId);
            if (field) {
                field.value = '';
            }
        });
    }

    // Helper function to set required attribute on new customer fields
    function setNewCustomerFieldsRequired(required) {
        const requiredFields = ['new_first_name', 'new_last_name', 'new_phone_number', 'new_address'];
        requiredFields.forEach(fieldId => {
            const field = document.getElementById(fieldId);
            if (field) {
                if (required) {
                    field.setAttribute('required', 'required');
                } else {
                    field.removeAttribute('required');
                }
            }
        });
    }

    // Function to validate new customer fields
    function validateNewCustomerFields() {
        const firstNameEl = document.getElementById('new_first_name');
        const lastNameEl = document.getElementById('new_last_name');
        const phoneNumberEl = document.getElementById('new_phone_number');
        const addressEl = document.getElementById('new_address');

        if (!firstNameEl || !lastNameEl || !phoneNumberEl || !addressEl) {
            showStatusMessage('New customer form elements not found.', 'error');
            return false;
        }

        const firstName = firstNameEl.value.trim();
        const lastName = lastNameEl.value.trim();
        const phoneNumber = phoneNumberEl.value.trim();
        const address = addressEl.value.trim();

        if (!firstName || !lastName || !phoneNumber || !address) {
            showStatusMessage('Please fill in all required new customer fields.', 'error');
            return false;
        }

        // Validate phone number (basic validation)
        const digitsOnly = phoneNumber.replace(/\D/g, '');
        if (digitsOnly.length < 10) {
            showStatusMessage('Phone number must contain at least 10 digits.', 'error');
            return false;
        }

        return true;
    }

    // Add validation for new customer fields
    function addNewCustomerValidation() {
        // Phone number validation
        const phoneInput = document.getElementById('new_phone_number');
        if (phoneInput) {
            phoneInput.addEventListener('input', function(e) {
            const phoneNumber = e.target.value;
            const digitsOnly = phoneNumber.replace(/\D/g, '');

            if (phoneNumber && digitsOnly.length < 10) {
                e.target.classList.add('border-red-500');
                e.target.classList.remove('border-gray-300');
            } else {
                e.target.classList.remove('border-red-500');
                e.target.classList.add('border-gray-300');
            }
            });
        }

        // Real-time validation for required fields
        const requiredFields = ['new_first_name', 'new_last_name', 'new_phone_number', 'new_address'];
        requiredFields.forEach(fieldId => {
            const field = document.getElementById(fieldId);
            if (field) {
                field.addEventListener('blur', function() {
                    if (field.hasAttribute('required') && !field.value.trim()) {
                        field.classList.add('border-red-500');
                        field.classList.remove('border-gray-300');
                    } else {
                        field.classList.remove('border-red-500');
                        field.classList.add('border-gray-300');
                    }
                });
            }
        });
    }

    // Function to create new customer and return customer data
    async function createNewCustomer() {
        if (!validateNewCustomerFields()) {
            return null;
        }

        const firstNameEl = document.getElementById('new_first_name');
        const lastNameEl = document.getElementById('new_last_name');
        const emailEl = document.getElementById('new_email');
        const phoneNumberEl = document.getElementById('new_phone_number');
        const addressEl = document.getElementById('new_address');

        if (!firstNameEl || !lastNameEl || !phoneNumberEl || !addressEl) {
            showStatusMessage('New customer form elements not found.', 'error');
            return null;
        }

        const firstName = firstNameEl.value.trim();
        const lastName = lastNameEl.value.trim();
        const email = emailEl ? emailEl.value.trim() : '';
        const phoneNumber = phoneNumberEl.value.trim();
        const address = addressEl.value.trim();

        // Generate a random username and password for the customer
        const randomStr = Math.random().toString(36).substring(2, 10);
        const username = 'customer_' + randomStr;
        const password = Math.random().toString(36).substring(2, 15);

        const customerData = {
            user: {
                username: username,
                email: email || username + '@example.com',
                password: password,
                first_name: firstName,
                last_name: lastName
            },
            phone_number: phoneNumber,
            address: address,
            measurements: {}
        };

        try {
            const response = await fetch('/api/register/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken
                },
                body: JSON.stringify(customerData)
            });

            if (!response.ok) {
                const errors = await response.json();
                throw new Error(JSON.stringify(errors));
            }

            const newCustomer = await response.json();
            showStatusMessage('New customer created successfully!', 'success');
            return newCustomer;
        } catch (error) {
            console.error('Error creating customer:', error);
            showStatusMessage('Error creating customer: ' + error.message, 'error');
            return null;
        }
    }

    // Load customers from API
    function loadCustomers() {
        loadCustomersWithCallback(null);
    }
    
    function loadCustomersWithCallback(callback) {
         console.log('loadCustomersWithCallback called with callback:', !!callback);
         fetch('/api/admin/customers/', {
             headers: {
                 'Authorization': 'Token ' + (localStorage.getItem('authToken') || sessionStorage.getItem('authToken') || ''),
                 'X-CSRFToken': csrfToken,
                 'Content-Type': 'application/json'
             },
             credentials: 'include'
         })
         .then(response => {
             console.log('Customer list response status:', response.status);
             if (!response.ok) {
                 throw new Error('Failed to load customers: ' + response.status);
             }
             return response.json();
         })
         .then(data => {
             console.log('Customers loaded. Response data:', data);
             const customers = data.results || data; // Handle both paginated and non-paginated responses
             console.log('Customers array:', customers);
             const customerSelect = document.getElementById('customer');
             // Clear existing options except the first one
             customerSelect.innerHTML = '<option value="">Select a customer</option>';
             
             customers.forEach(customer => {
                 const option = document.createElement('option');
                 option.value = customer.id;
                 option.textContent = `${customer.user.first_name} ${customer.user.last_name} (${customer.user.username})`;
                 customerSelect.appendChild(option);
             });
             
             console.log('Customers dropdown populated with', customers.length, 'customers');
             
             // Check if we need to auto-select a customer
             if (callback) {
                 // First check URL parameter (highest priority)
                 const urlParams = new URLSearchParams(window.location.search);
                 let customerId = urlParams.get('customer');
                 console.log('URL parameter customer id:', customerId);
                 
                 // If no URL param, check localStorage
                 if (!customerId) {
                     customerId = localStorage.getItem('lastCreatedCustomerId');
                     console.log('localStorage customer id:', customerId);
                 }
                 
                 // Clear localStorage after reading it to avoid future unwanted selections
                 if (customerId) {
                     console.log('Auto-selecting customer:', customerId);
                     localStorage.removeItem('lastCreatedCustomerId');
                     callback(customerId);
                 } else {
                     console.log('No customer ID found to auto-select');
                 }
             }
         })
         .catch(error => {
             console.error('Error loading customers:', error);
             showStatusMessage('Error loading customers. Please refresh the page.', 'error');
         });
     }
    

    

    
    // Load tailors from API, filtered by garment type
    function loadTailors(garmentType) {
        const tailorSelect = document.getElementById('tailor');
        if (!tailorSelect) return;
        
        fetch('/api/admin/tailors/', {
            headers: {
                'Authorization': 'Token ' + (localStorage.getItem('authToken') || sessionStorage.getItem('authToken') || ''),
                'X-CSRFToken': csrfToken,
                'Content-Type': 'application/json'
            },
            credentials: 'include'
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Failed to load tailors: ' + response.status);
            }
            return response.json();
        })
        .then(data => {
            const allTailors = data.results || data; // Handle both paginated and non-paginated responses
            
            // Clear existing options
            tailorSelect.innerHTML = '<option value="">Do not assign (create pending order)</option>';
            
            // Filter tailors by garment type if one is selected
            let filteredTailors = allTailors;
            if (garmentType) {
                filteredTailors = allTailors.filter(tailor => {
                    const specialty = (tailor.specialty || '').toUpperCase().trim();
                    const garment = (garmentType || '').toUpperCase().trim();
                    
                    // Check if specialty matches garment type or is a general specialty
                    // 1. Exact match (POLO = POLO, PANTS = PANTS, etc.)
                    // 2. General/All purpose tailors
                    // 3. Partial match (specialty contains garment type)
                    // 4. Special case mappings
                    return specialty === garment || 
                           specialty === 'GENERAL' || 
                           specialty === 'ALL' ||
                           specialty.includes(garment) ||
                           (specialty.includes('SHIRT') && (garment === 'POLO' || garment === 'BLOUSE')) ||
                           (garment.includes('SHIRT') && specialty.includes('SHIRT')) ||
                           (specialty === 'TOP' && (garment === 'POLO' || garment === 'BLOUSE' || garment === 'TOP'));
                });
            }
            
            if (filteredTailors.length === 0) {
                const option = document.createElement('option');
                option.value = '';
                option.textContent = garmentType ? 'No tailors available for this garment type' : 'No tailors available';
                option.disabled = true;
                tailorSelect.appendChild(option);
            } else {
                filteredTailors.forEach(tailor => {
                    const option = document.createElement('option');
                    option.value = tailor.id;
                    option.textContent = `${tailor.user.first_name} ${tailor.user.last_name} (${tailor.specialty})`;
                    tailorSelect.appendChild(option);
                });
            }
        })
        .catch(error => {
            console.error('Error loading tailors:', error);
            showStatusMessage('Error loading tailors. Please refresh the page.', 'error');
        });
    }

    // Load fabrics from API and populate the fabric select (uses Fabric.id as value)
    function loadFabrics() {
        fetch('/api/admin/fabrics/', {
            headers: {
                'Authorization': 'Token ' + (localStorage.getItem('authToken') || sessionStorage.getItem('authToken') || ''),
                'X-CSRFToken': csrfToken,
                'Content-Type': 'application/json'
            },
            credentials: 'include'
        })
        .then(response => {
            if (!response.ok) throw new Error('Failed to load fabrics: ' + response.status);
            return response.json();
        })
        .then(data => {
            const fabrics = data.results || data;
            const fabricSelect = document.getElementById('fabric_type');
            if (!fabricSelect) return;

            // Preserve the 'Other' option if present
            const otherOption = Array.from(fabricSelect.options).find(opt => opt.value === '__other');

            fabricSelect.innerHTML = '<option value="">Select a fabric</option>';
            fabrics.forEach(fabric => {
                const option = document.createElement('option');
                option.value = fabric.id;
                option.textContent = fabric.name;
                fabricSelect.appendChild(option);
            });

            if (otherOption) fabricSelect.appendChild(otherOption);
        })
        .catch(error => {
            console.error('Error loading fabrics:', error);
            // Keep the existing hard-coded options if API fails
        });
    }
    
    // Load accessories from API and populate the accessories checkboxes
    function loadAccessories() {
        const container = document.getElementById('accessories_container');
        if (!container) return;

        fetch('/api/admin/accessories/', {
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken,
                ...(sessionStorage.getItem('authToken') || localStorage.getItem('authToken') ? { 'Authorization': 'Token ' + (sessionStorage.getItem('authToken') || localStorage.getItem('authToken')) } : {})
            },
            credentials: 'include'
        })
        .then(response => {
            if (!response.ok) throw new Error('Failed to load accessories: ' + response.status);
            return response.json();
        })
        .then(data => {
            const accessories = data.results || data;
            container.innerHTML = '';
            
            if (accessories.length === 0) {
                container.innerHTML = '<p class="col-span-full text-gray-500">No accessories available</p>';
                return;
            }
            
            accessories.forEach(a => {
                const isLow = typeof a.low_stock_threshold !== 'undefined' && a.quantity <= a.low_stock_threshold;
                const price = a.price_per_unit !== undefined ? `₱${Number(a.price_per_unit).toFixed(2)}` : '';
                
                const checkboxDiv = document.createElement('div');
                checkboxDiv.className = 'flex items-start p-3 bg-white rounded border border-gray-200 hover:border-green-400 transition-colors';
                
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.id = `accessory_${a.id}`;
                checkbox.name = 'accessories_ids';
                checkbox.value = a.id;
                checkbox.className = 'h-4 w-4 text-green-600 focus:ring-green-500 border-gray-300 rounded mt-1';
                checkbox.dataset.available = a.quantity;
                checkbox.dataset.price = a.price_per_unit;
                
                // Store applicable garments as comma-separated codes for filtering
                // Empty string means universal (applicable to all garments)
                checkboxDiv.dataset.applicableGarments = (a.applicable_garments || []).join(',');
                
                const label = document.createElement('label');
                label.htmlFor = `accessory_${a.id}`;
                label.className = 'ml-3 flex-1 cursor-pointer';
                
                const nameDiv = document.createElement('div');
                nameDiv.className = 'text-sm font-medium text-gray-800';
                nameDiv.textContent = a.name;
                
                const priceQtyDiv = document.createElement('div');
                priceQtyDiv.className = 'text-xs text-gray-600 mt-1';
                const qtyClass = isLow ? 'text-red-600 font-semibold' : '';
                const lowBadge = isLow ? ' <span class="ml-2 inline-block bg-red-100 text-red-800 px-2 py-1 rounded text-xs font-medium">LOW STOCK</span>' : '';
                priceQtyDiv.innerHTML = `${price} • Stock: <span class="${qtyClass}">${a.quantity}</span>${lowBadge}`;
                
                label.appendChild(nameDiv);
                label.appendChild(priceQtyDiv);
                
                checkboxDiv.appendChild(checkbox);
                checkboxDiv.appendChild(label);
                
                container.appendChild(checkboxDiv);
            });
            // After loading accessories, apply garment-based filtering if a garment is selected
            try {
                const currentGarment = document.getElementById('garment_type') ? document.getElementById('garment_type').value : null;
                if (currentGarment) filterAccessoriesByGarment(currentGarment);
            } catch (e) {
                // ignore
            }
        })
        .catch(err => {
            console.error('Error loading accessories:', err);
            container.innerHTML = '<p class="col-span-full text-red-500">Error loading accessories</p>';
        });
    }

    // Use shared pricing logic from pricing.js
    function updatePricingDisplay() {
        PricingManager.updatePricingDisplay({
            garmentTypeSelector: '#garment_type',
            quantitySelector: '#quantity',
            garmentPriceSelector: '#garment_price_display',
            totalAmountSelector: '#total_amount_display',
            downPaymentSelector: '#down_payment_display',
            totalAmountInputSelector: '#total_amount'
        });

        // Update payment amount display
        updatePaymentAmountDisplay();
    }
    
    // Load customer measurements and auto-populate order fields
    function loadCustomerMeasurements(customerId) {
        fetch(`/api/admin/customers/${customerId}/`, {
            headers: {
                'Authorization': 'Token ' + (localStorage.getItem('authToken') || sessionStorage.getItem('authToken') || ''),
                'X-CSRFToken': csrfToken,
                'Content-Type': 'application/json'
            },
            credentials: 'include'
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Failed to load customer measurements: ' + response.status);
            }
            return response.json();
        })
        .then(data => {
            // Handle both paginated and non-paginated responses
            const customer = data.results || data;

            // Display basic measurements
            const basicMeasurements = document.getElementById('basicMeasurements');
            if (customer.measurements && Object.keys(customer.measurements).length > 0) {
                let measurementsHtml = '<div class="grid grid-cols-2 md:grid-cols-3 gap-4">';
                for (const [key, value] of Object.entries(customer.measurements)) {
                    const displayKey = key.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                    measurementsHtml += `
                        <div class="bg-white p-3 rounded border">
                            <div class="text-xs text-gray-500 uppercase">${displayKey}</div>
                            <div class="font-medium">${value} inches</div>
                        </div>
                    `;
                }
                measurementsHtml += '</div>';

                // Add auto-populate button
                measurementsHtml += `
                    <div class="mt-4 p-4 bg-blue-50 border border-blue-200 rounded-lg">
                        <div class="flex items-center justify-between">
                            <div>
                                <h4 class="text-sm font-medium text-blue-800">Auto-populate Order Measurements</h4>
                                <p class="text-xs text-blue-600 mt-1">Click to automatically fill order measurement fields with customer's measurements</p>
                            </div>
                            <button type="button" id="autoPopulateBtn" onclick="autoPopulateOrderMeasurements()"
                                class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors">
                                <i class="fas fa-magic mr-2"></i>Auto-Fill
                            </button>
                        </div>
                    </div>
                `;

                basicMeasurements.innerHTML = measurementsHtml;

                // Store customer measurements globally for auto-population
                window.customerMeasurements = customer.measurements;
            } else {
                basicMeasurements.innerHTML = '<p class="text-gray-500">No basic measurements recorded for this customer</p>';
                window.customerMeasurements = {};
            }
        })
        .catch(error => {
            console.error('Error loading customer measurements:', error);
            const basicMeasurementsEl = document.getElementById('basicMeasurements');
            if (basicMeasurementsEl) {
                basicMeasurementsEl.innerHTML = '<p class="text-red-500">Error loading measurements</p>';
            }
            window.customerMeasurements = {};
        });
    }

    // Auto-populate order measurement fields with customer measurements
    function autoPopulateOrderMeasurements() {
        if (!window.customerMeasurements || Object.keys(window.customerMeasurements).length === 0) {
            showStatusMessage('No customer measurements available to populate', 'error');
            return;
        }

        const garmentType = document.getElementById('garment_type').value;
        if (!garmentType) {
            showStatusMessage('Please select a garment type first', 'error');
            return;
        }

        let populatedCount = 0;

        // Helper function to populate field if it exists and customer has the measurement
        function populateField(fieldId, measurementKey) {
            const field = document.getElementById(fieldId);
            const value = window.customerMeasurements[measurementKey];

            if (field && value !== undefined && value !== null) {
                field.value = value;
                field.classList.add('bg-green-50', 'border-green-300');
                populatedCount++;

                // Remove highlight after 2 seconds
                setTimeout(() => {
                    field.classList.remove('bg-green-50', 'border-green-300');
                }, 2000);
            }
        }

        // Populate fields based on garment type
        if (garmentType === 'BLOUSE' || garmentType === 'DRESS') {
            populateField('neck_circumference', 'neck_circumference');
            populateField('shoulder_width', 'shoulder_width');
            populateField('chest_bust_circumference', 'chest_bust_circumference');
            populateField('upper_bust_circumference', 'upper_bust_circumference');
            populateField('under_bust_circumference', 'under_bust_circumference');
            populateField('waist_circumference', 'waist_circumference');
            populateField('armhole_circumference', 'armhole_circumference');
            populateField('bicep_circumference', 'bicep_circumference');
            populateField('wrist_circumference', 'wrist_circumference');
            populateField('back_length_nape_to_waist', 'back_length_nape_to_waist');
            populateField('blouse_length_shoulder_to_hem', 'blouse_length_shoulder_to_hem');
        }

        if (garmentType === 'PANTS') {
            populateField('waist_circumference_pants', 'waist_circumference');
            populateField('high_hip_circumference', 'high_hip_circumference');
            populateField('full_hip_circumference', 'full_hip_circumference');
            populateField('thigh_circumference', 'thigh_circumference');
            populateField('knee_circumference', 'knee_circumference');
            populateField('calf_circumference', 'calf_circumference');
            populateField('ankle_circumference', 'ankle_circumference');
            populateField('inseam_crotch_to_ankle', 'inseam_crotch_to_ankle');
            populateField('outseam_waist_to_ankle', 'outseam_waist_to_ankle');
            populateField('front_rise', 'front_rise');
            populateField('back_rise', 'back_rise');
        }

        if (garmentType === 'SKIRT' || garmentType === 'DRESS') {
            populateField('waist_circumference_skirt', 'waist_circumference');
            populateField('high_hip_circumference_skirt', 'high_hip_circumference');
            populateField('full_hip_circumference_skirt', 'full_hip_circumference');
            populateField('skirt_dress_length', 'skirt_dress_length');
            populateField('hem_circumference', 'hem_circumference');
        }

        if (garmentType === 'JACKET') {
            populateField('neck_circumference_jacket', 'neck_circumference');
            populateField('shoulder_width_jacket', 'shoulder_width');
            populateField('chest_bust_circumference_jacket', 'chest_bust_circumference');
            populateField('waist_circumference_jacket', 'waist_circumference');
            populateField('full_hip_circumference_jacket', 'full_hip_circumference');
            populateField('bicep_circumference_jacket', 'bicep_circumference');
            populateField('wrist_circumference_jacket', 'wrist_circumference');
            populateField('jacket_length_shoulder_to_hem', 'jacket_length_shoulder_to_hem');
        }

        if (populatedCount > 0) {
            showStatusMessage(`Successfully auto-populated ${populatedCount} measurement fields from customer profile`, 'success');
        } else {
            showStatusMessage('No matching measurements found to populate for this garment type', 'warning');
        }
    }

    // Filter accessories shown in the accessories container based on selected garment type.
    // Uses the applicable_garments field from the API. Accessories with empty applicable_garments
    // are treated as universal and shown for all garment types.
    function filterAccessoriesByGarment(garmentType) {
        const container = document.getElementById('accessories_container');
        if (!container) return;

        Array.from(container.children).forEach(div => {
            const applicableGarmentsStr = div.dataset.applicableGarments || '';
            const applicableGarments = applicableGarmentsStr ? applicableGarmentsStr.split(',') : [];

            // If empty applicable_garments, it's universal - always show
            if (applicableGarments.length === 0) {
                div.style.display = 'flex';
                return;
            }

            // Show if current garment type is in the applicable list
            const matches = applicableGarments.includes(garmentType);
            div.style.display = matches ? 'flex' : 'none';

            // Uncheck hidden checkboxes so they don't get submitted
            const cb = div.querySelector('input[type="checkbox"]');
            if (cb && div.style.display === 'none') cb.checked = false;
        });
    }
    
    function showStatusMessage(message, type) {
        const statusElement = document.getElementById('statusMessage');
        // Allow HTML in message (we control messages in this UI)
        statusElement.innerHTML = message;
        
        statusElement.classList.remove('hidden', 'bg-green-100', 'text-green-800', 'bg-red-100', 'text-red-800');
        
        if (type === 'success') {
            statusElement.classList.add('bg-green-100', 'text-green-800');
        } else {
            statusElement.classList.add('bg-red-100', 'text-red-800');
        }
        
        statusElement.classList.remove('hidden');
        
        // Auto-hide success messages after 5 seconds
        if (type === 'success') {
            setTimeout(() => {
                statusElement.classList.add('hidden');
            }, 5000);
        }
    }

    // Validation functions
    function validateDueDate() {
        const dueDateInput = document.getElementById('due_date');
        const today = new Date();
        const selectedDate = new Date(dueDateInput.value);

        if (selectedDate <= today) {
             showFieldError(dueDateInput, 'Expected delivery date must be in the future');
             return false;
         }

        clearFieldError(dueDateInput);
        return true;
    }

    function validateQuantity() {
        const quantityInput = document.getElementById('quantity');
        const quantity = parseInt(quantityInput.value);

        if (!quantity || quantity < 1) {
            showFieldError(quantityInput, 'Quantity must be at least 1');
            return false;
        }

        if (quantity > 100) {
            showFieldError(quantityInput, 'Quantity cannot exceed 100');
            return false;
        }

        clearFieldError(quantityInput);
        return true;
    }

    function validateMeasurements() {
        const garmentType = document.getElementById('garment_type').value;
        if (!garmentType) return true; // Skip validation if no garment type selected

        const measurementSections = document.querySelectorAll('.measurement-section:not(.hidden)');
        let isValid = true;

        measurementSections.forEach(section => {
            const inputs = section.querySelectorAll('input[type="number"]');
            inputs.forEach(input => {
                const value = parseFloat(input.value);
                if (input.hasAttribute('required') && (!value || value <= 0)) {
                    showFieldError(input, 'This measurement is required and must be greater than 0');
                    isValid = false;
                } else if (value && (value < 0 || value > 200)) {
                    showFieldError(input, 'Measurement must be between 0 and 200 inches');
                    isValid = false;
                } else {
                    clearFieldError(input);
                }
            });
        });

        return isValid;
    }

    function showFieldError(field, message) {
        clearFieldError(field);

        const errorDiv = document.createElement('div');
        errorDiv.className = 'field-error text-red-500 text-sm mt-1';
        errorDiv.textContent = message;

        field.classList.add('border-red-500');
        field.parentNode.appendChild(errorDiv);
    }

    function clearFieldError(field) {
        field.classList.remove('border-red-500');
        const existingError = field.parentNode.querySelector('.field-error');
        if (existingError) {
            existingError.remove();
        }
    }

    // Add event listeners for real-time validation
    document.addEventListener('DOMContentLoaded', function() {
        const dueDateInput = document.getElementById('due_date');
        const quantityInput = document.getElementById('quantity');

        dueDateInput.addEventListener('change', validateDueDate);
        quantityInput.addEventListener('input', validateQuantity);

        // Add measurement validation on input
        document.addEventListener('input', function(e) {
            if (e.target.type === 'number' && e.target.closest('.measurement-section')) {
                const value = parseFloat(e.target.value);
                if (value && (value < 0 || value > 200)) {
                    showFieldError(e.target, 'Measurement must be between 0 and 200 inches');
                } else {
                    clearFieldError(e.target);
                }
            }
        });

        // Validate form before submission
        const form = document.getElementById('orderForm');
        form.addEventListener('submit', function(e) {
            let isValid = true;

            // Clear previous status messages
            document.getElementById('statusMessage').classList.add('hidden');

            // Validate all fields
            if (!validateDueDate()) isValid = false;
            if (!validateQuantity()) isValid = false;
            if (!validateMeasurements()) isValid = false;

            // Check required fields
            const requiredFields = form.querySelectorAll('[required]');
            requiredFields.forEach(field => {
                if (!field.value.trim()) {
                    showFieldError(field, 'This field is required');
                    isValid = false;
                }
            });

            if (!isValid) {
                e.preventDefault();
                showStatusMessage('Please fix the validation errors before submitting.', 'error');
                return false;
            }
        });
    });

    // Helper to open a printable receipt window for an order
    function printOrderReceipt(order) {
        if (!order) return;
        
        // If status is PAID, balance must be 0 (fix for full payment selection)
        const isPaid = order.payment_status === 'PAID';
        const balance = isPaid ? 0 : parseFloat(order.remaining_balance || 0);
        
        const w = window.open('', '_blank');
        if (!w) {
            showModal('Popup blocked', 'Popup blocked. Please allow popups to print the receipt.');
            return;
        }

        const html = `
            <html>
            <head>
                <title>Receipt - Order #${order.id}</title>
                <style>
                    body { font-family: Arial, sans-serif; padding: 24px; }
                    .header { text-align: center; margin-bottom: 20px; }
                    .row { display:flex; justify-content:space-between; margin-bottom:8px; }
                    .total { font-weight: bold; font-size: 1.1em; }
                </style>
            </head>
            <body>
                <div class="header">
                    <h2>El Senior Dumingag</h2>
                    <div>Order Receipt</div>
                </div>
                <div class="row"><div>Order ID:</div><div>#${order.id}</div></div>
                <div class="row"><div>Customer:</div><div>${order.customer && order.customer.user ? (order.customer.user.first_name + ' ' + order.customer.user.last_name) : 'N/A'}</div></div>
                <div class="row"><div>Created:</div><div>${order.created_at ? new Date(order.created_at).toLocaleString() : ''}</div></div>
                <hr />
                <div class="row"><div>Total Amount:</div><div>₱${Number(order.total_amount || 0).toFixed(2)}</div></div>
                ${(!isPaid && Number(order.down_payment_amount || 0) > 0) ? `
                <div class="row"><div>Down Payment:</div><div>₱${Number(order.down_payment_amount || 0).toFixed(2)}</div></div>
                ` : ''}
                <div class="row"><div>Remaining Balance:</div><div>₱${Number(balance).toFixed(2)}</div></div>
                <div class="row total"><div>Payment Status:</div><div>${order.payment_status || ''}</div></div>
                <hr />
                <div style="margin-top:20px;">Thank you for your business.</div>
                <script>window.onload = function(){ window.print(); };<\/script>
            </body>
            </html>
        `;

        w.document.write(html);
        w.document.close();
    }

    // Modal helpers
    function showModal(title, bodyHtml) {
        const modal = document.getElementById('globalModal');
        const titleEl = document.getElementById('globalModalTitle');
        const bodyEl = document.getElementById('globalModalBody');
        const okBtn = document.getElementById('globalModalOk');
        const closeBtn = document.getElementById('globalModalClose');

        if (!modal || !titleEl || !bodyEl) {
            alert(title + '\n\n' + bodyHtml);
            return;
        }

        titleEl.textContent = title || '';
        bodyEl.innerHTML = bodyHtml || '';

        // Show modal
        modal.classList.remove('hidden');
        modal.classList.add('flex');

        function hide() {
            modal.classList.add('hidden');
            modal.classList.remove('flex');
            okBtn.removeEventListener('click', hide);
            closeBtn.removeEventListener('click', hide);
        }

        okBtn.addEventListener('click', hide);
        closeBtn.addEventListener('click', hide);
    }
</script>
{% endblock %}