{% extends 'base.html' %}
{% load static %}

{% block title %}Performance Reports - StitchFlow{% endblock %}

{% block extra_css %}
<style>
    /* Minimal custom styles that work with Tailwind */
    .slide-up {
        animation: slideUp 0.6s ease-out forwards;
        opacity: 0;
        transform: translateY(20px);
    }

    .slide-up:nth-child(1) { animation-delay: 0.1s; }
    .slide-up:nth-child(2) { animation-delay: 0.2s; }
    .slide-up:nth-child(3) { animation-delay: 0.3s; }
    .slide-up:nth-child(4) { animation-delay: 0.4s; }

    @keyframes slideUp {
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .floating {
        animation: floating 3s ease-in-out infinite;
    }

    @keyframes floating {
        0%, 100% { transform: translateY(0px); }
        50% { transform: translateY(-5px); }
    }

    /* Custom date range styles */
    .custom-date-range {
        max-height: 0;
        overflow: hidden;
        transition: max-height 0.3s ease-out;
        opacity: 0;
    }

    .custom-date-range.show {
        max-height: 200px;
        opacity: 1;
        margin-top: 1.5rem;
    }

    /* Loading modal styles */
    .loading-modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        background-color: rgba(0, 0, 0, 0.5);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 9999;
        transition: all 0.3s ease-in-out;
    }

    .loading-modal.show {
        display: flex !important;
        align-items: center !important;
        justify-content: center !important;
    }

    .loading-spinner {
        width: 3rem;
        height: 3rem;
        border: 3px solid #e5e7eb;
        border-top: 3px solid #6366f1;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin: 0 auto 1rem;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    /* Notification styles */
    .notification {
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 1001;
        transform: translateX(400px);
        transition: transform 0.3s ease-in-out;
        max-width: 400px;
    }

    .notification.show {
        transform: translateX(0);
    }
</style>
{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto p-6 space-y-8">

    <!-- Page Header -->
    <div class="bg-gradient-to-r from-indigo-600 to-purple-600 rounded-2xl p-8 text-white shadow-xl slide-up">
        <div class="flex items-center justify-between">
            <div class="flex items-center space-x-6">
                <div class="bg-white/20 rounded-2xl p-4 backdrop-blur-sm floating">
                    <i class="fas fa-chart-line text-3xl"></i>
                </div>
                <div>
                    <h1 class="text-4xl font-bold mb-2">Performance Reports</h1>
                    <p class="text-indigo-100 text-lg">Generate comprehensive performance and earnings reports</p>
                </div>
            </div>
            <div class="text-right">
                <div class="bg-white/10 rounded-xl px-4 py-2 backdrop-blur-sm">
                    <div class="flex items-center space-x-2 text-white/90">
                        <i class="fas fa-calendar-alt"></i>
                        <span class="font-semibold">{{ now|date:"F j, Y" }}</span>
                    </div>
                </div>
                <div class="flex items-center justify-end space-x-2 mt-2 text-white/80 text-sm">
                    <div class="w-2 h-2 bg-green-400 rounded-full animate-pulse"></div>
                    <span>System Online</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Tailor Information -->
    <div class="bg-white rounded-2xl shadow-lg p-8 slide-up" style="animation-delay: 0.2s;">
        <div class="flex items-center space-x-6">
            <div class="relative">
                <div class="w-20 h-20 bg-gradient-to-r from-indigo-500 to-purple-600 rounded-2xl flex items-center justify-center shadow-lg">
                    <i class="fas fa-user-tie text-3xl text-white"></i>
                </div>
                <div class="absolute -top-2 -right-2 w-6 h-6 bg-green-500 rounded-full border-4 border-white shadow-md animate-pulse"></div>
            </div>
            <div class="flex-1">
                <h2 class="text-2xl font-bold text-gray-900 mb-2">{{ tailor.user.get_full_name }}</h2>
                <div class="flex flex-wrap items-center gap-3 mb-3">
                    <span class="bg-gradient-to-r from-indigo-500 to-purple-600 text-white px-3 py-1 rounded-full text-sm font-semibold shadow-md">
                        <i class="fas fa-star mr-1"></i>
                        Professional Tailor
                    </span>
                    <span class="bg-gray-100 text-gray-700 px-3 py-1 rounded-full text-sm font-semibold">
                        <i class="fas fa-id-badge mr-1"></i>
                        ID: T{{ tailor.id|stringformat:"04d" }}
                    </span>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div class="flex items-center space-x-2 text-gray-600 bg-blue-50 px-3 py-2 rounded-lg">
                        <i class="fas fa-envelope text-blue-500"></i>
                        <span class="text-sm font-medium">{{ tailor.user.email }}</span>
                    </div>
                    {% if tailor.phone_number %}
                    <div class="flex items-center space-x-2 text-gray-600 bg-green-50 px-3 py-2 rounded-lg">
                        <i class="fas fa-phone text-green-500"></i>
                        <span class="text-sm font-medium">{{ tailor.phone_number }}</span>
                    </div>
                    {% endif %}
                    <div class="flex items-center space-x-2 text-gray-600 bg-purple-50 px-3 py-2 rounded-lg">
                        <i class="fas fa-calendar-plus text-purple-500"></i>
                        <span class="text-sm font-medium">Joined {{ tailor.user.date_joined|date:"M Y" }}</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Statistics Cards -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
        <!-- Total Tasks -->
        <div class="bg-white rounded-2xl shadow-lg p-6 slide-up floating border-t-4 border-indigo-500 hover:shadow-xl transition-all duration-300 hover:-translate-y-1">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm font-semibold text-gray-600 uppercase tracking-wide">Total Tasks</p>
                    <p class="text-3xl font-bold text-gray-900 mt-2">{{ total_tasks }}</p>
                </div>
                <div class="bg-gradient-to-r from-indigo-500 to-purple-600 rounded-xl p-3">
                    <i class="fas fa-tasks text-2xl text-white"></i>
                </div>
            </div>
        </div>

        <!-- Completed Tasks -->
        <div class="bg-white rounded-2xl shadow-lg p-6 slide-up floating border-t-4 border-green-500 hover:shadow-xl transition-all duration-300 hover:-translate-y-1" style="animation-delay: 0.2s;">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm font-semibold text-gray-600 uppercase tracking-wide">Completed Tasks</p>
                    <p class="text-3xl font-bold text-gray-900 mt-2">{{ completed_tasks }}</p>
                    <p class="text-sm text-gray-500 mt-1 font-medium">
                        {% if total_tasks > 0 %}{{ completion_rate|floatformat:1 }}% completion rate{% else %}No tasks yet{% endif %}
                    </p>
                </div>
                <div class="bg-gradient-to-r from-green-500 to-emerald-600 rounded-xl p-3">
                    <i class="fas fa-check-circle text-2xl text-white"></i>
                </div>
            </div>
        </div>

        <!-- In Progress -->
        <div class="bg-white rounded-2xl shadow-lg p-6 slide-up floating border-t-4 border-yellow-500 hover:shadow-xl transition-all duration-300 hover:-translate-y-1" style="animation-delay: 0.4s;">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm font-semibold text-gray-600 uppercase tracking-wide">In Progress</p>
                    <p class="text-3xl font-bold text-gray-900 mt-2">{{ in_progress_tasks }}</p>
                </div>
                <div class="bg-gradient-to-r from-yellow-500 to-orange-600 rounded-xl p-3">
                    <i class="fas fa-clock text-2xl text-white"></i>
                </div>
            </div>
        </div>

        <!-- Total Earnings -->
        <div class="bg-white rounded-2xl shadow-lg p-6 slide-up floating border-t-4 border-red-500 hover:shadow-xl transition-all duration-300 hover:-translate-y-1" style="animation-delay: 0.6s;">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm font-semibold text-gray-600 uppercase tracking-wide">Total Earnings</p>
                    <p class="text-3xl font-bold text-gray-900 mt-2">â‚±{{ total_commissions|floatformat:0 }}</p>
                </div>
                <div class="bg-gradient-to-r from-red-500 to-pink-600 rounded-xl p-3">
                    <i class="fas fa-money-bill-wave text-2xl text-white"></i>
                </div>
            </div>
        </div>
    </div>

    <!-- Report Generation Section -->
    <div class="bg-white rounded-2xl shadow-lg p-8 slide-up" style="animation-delay: 0.8s;">
        <div class="mb-8">
            <div class="flex items-center space-x-4 mb-6">
                <div class="bg-gradient-to-r from-indigo-500 to-purple-600 rounded-xl p-3 floating">
                    <i class="fas fa-chart-bar text-2xl text-white"></i>
                </div>
                <div>
                    <h3 class="text-2xl font-bold text-gray-900">Generate Report</h3>
                    <p class="text-gray-600">Create comprehensive performance and earnings reports</p>
                </div>
            </div>
        </div>

        <!-- Time Period Selection -->
        <div class="mb-8">
            <h4 class="text-xl font-bold text-gray-900 mb-6 flex items-center gap-3">
                <div class="w-8 h-8 bg-blue-100 rounded-lg flex items-center justify-center">
                    <i class="fas fa-calendar-alt text-blue-600"></i>
                </div>
                Select Time Period
            </h4>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                <button type="button" class="period-btn bg-gradient-to-r from-indigo-500 to-purple-600 text-white border-2 border-transparent rounded-xl p-6 text-center cursor-pointer transition-all duration-300 shadow-lg transform -translate-y-1 focus:outline-none focus:ring-4 focus:ring-indigo-200" data-period="last_month" onclick="selectPeriod('last_month', this)">
                    <i class="fas fa-calendar-alt text-2xl mb-3 block"></i>
                    <span class="block font-bold text-lg mb-1">Last Month</span>
                    <span class="block text-sm opacity-90">Previous 30 days</span>
                </button>
                <button type="button" class="period-btn bg-white border-2 border-gray-200 hover:border-indigo-500 rounded-xl p-6 text-center cursor-pointer transition-all duration-300 shadow-md hover:shadow-lg focus:outline-none focus:ring-4 focus:ring-indigo-200" data-period="last_quarter" onclick="selectPeriod('last_quarter', this)">
                    <i class="fas fa-calendar-week text-2xl mb-3 block text-gray-600"></i>
                    <span class="block font-bold text-lg mb-1 text-gray-900">Last Quarter</span>
                    <span class="block text-sm text-gray-600">Previous 3 months</span>
                </button>
                <button type="button" class="period-btn bg-white border-2 border-gray-200 hover:border-indigo-500 rounded-xl p-6 text-center cursor-pointer transition-all duration-300 shadow-md hover:shadow-lg focus:outline-none focus:ring-4 focus:ring-indigo-200" data-period="ytd" onclick="selectPeriod('ytd', this)">
                    <i class="fas fa-calendar-year text-2xl mb-3 block text-gray-600"></i>
                    <span class="block font-bold text-lg mb-1 text-gray-900">Year to Date</span>
                    <span class="block text-sm text-gray-600">Jan 1 to today</span>
                </button>
                <button type="button" class="period-btn bg-white border-2 border-gray-200 hover:border-indigo-500 rounded-xl p-6 text-center cursor-pointer transition-all duration-300 shadow-md hover:shadow-lg focus:outline-none focus:ring-4 focus:ring-indigo-200" data-period="all_time" onclick="selectPeriod('all_time', this)">
                    <i class="fas fa-infinity text-2xl mb-3 block text-gray-600"></i>
                    <span class="block font-bold text-lg mb-1 text-gray-900">All Time</span>
                    <span class="block text-sm text-gray-600">Complete history</span>
                </button>
                <button type="button" class="period-btn bg-white border-2 border-gray-200 hover:border-indigo-500 rounded-xl p-6 text-center cursor-pointer transition-all duration-300 shadow-md hover:shadow-lg focus:outline-none focus:ring-4 focus:ring-indigo-200" data-period="last_week" onclick="selectPeriod('last_week', this)">
                    <i class="fas fa-calendar-day text-2xl mb-3 block text-gray-600"></i>
                    <span class="block font-bold text-lg mb-1 text-gray-900">Last Week</span>
                    <span class="block text-sm text-gray-600">Previous 7 days</span>
                </button>
                <button type="button" class="period-btn bg-white border-2 border-gray-200 hover:border-indigo-500 rounded-xl p-6 text-center cursor-pointer transition-all duration-300 shadow-md hover:shadow-lg focus:outline-none focus:ring-4 focus:ring-indigo-200" data-period="custom" onclick="selectPeriod('custom', this)">
                    <i class="fas fa-calendar-plus text-2xl mb-3 block text-gray-600"></i>
                    <span class="block font-bold text-lg mb-1 text-gray-900">Custom Range</span>
                    <span class="block text-sm text-gray-600">Choose dates</span>
                </button>
            </div>
        </div>

        <!-- Custom Date Range -->
        <div id="customDateRange" class="custom-date-range">
            <h5 class="text-lg font-semibold text-gray-900 mb-4">Custom Date Range</h5>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2" for="dateFrom">From Date</label>
                    <input type="date" id="dateFrom" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition-colors">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2" for="dateTo">To Date</label>
                    <input type="date" id="dateTo" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition-colors">
                </div>
            </div>
            <div class="mt-4 p-4 bg-blue-50 rounded-lg flex items-center space-x-3">
                <i class="fas fa-info-circle text-blue-500"></i>
                <span class="text-sm text-blue-700">Select a date range to generate a custom report for the specified period.</span>
            </div>
        </div>

        <!-- Generate Button -->
        <div class="mt-8 text-center">
            <div class="mb-6">
                <div class="flex items-center justify-center mb-4">
                    <div class="w-12 h-12 bg-green-100 rounded-full flex items-center justify-center">
                        <i class="fas fa-check text-green-600 text-xl"></i>
                    </div>
                </div>
                <h4 class="text-xl font-bold text-gray-900 mb-2">Ready to Generate Report</h4>
                <p class="text-gray-600 max-w-md mx-auto">
                    Your comprehensive report will include task performance metrics, earnings breakdown, completion rates, and detailed analytics.
                </p>
            </div>

            <button type="button" id="generateReportBtn" class="bg-gradient-to-r from-indigo-500 to-purple-600 text-white px-8 py-4 rounded-xl font-bold text-lg shadow-lg hover:shadow-xl transform hover:-translate-y-1 transition-all duration-300 focus:outline-none focus:ring-4 focus:ring-indigo-200" onclick="generateReport()">
                <i class="fas fa-file-pdf mr-3 text-xl"></i>
                <span id="generateBtnText">Generate Performance Report</span>
            </button>

            <div class="mt-6">
                <div class="flex items-center justify-center gap-2 text-sm text-gray-500 bg-gray-50 px-4 py-2 rounded-lg inline-flex">
                    <i class="fas fa-shield-alt text-green-500"></i>
                    <span class="font-medium">Your data is processed securely and confidentially</span>
                </div>
            </div>
        </div>

        <!-- Error Message -->
        <div id="errorMessage" class="hidden mt-6 p-4 bg-red-50 border-2 border-red-200 rounded-xl">
            <div class="flex items-center gap-3 text-red-700">
                <div class="w-8 h-8 bg-red-100 rounded-full flex items-center justify-center flex-shrink-0">
                    <i class="fas fa-exclamation-triangle text-red-600"></i>
                </div>
                <span id="errorText" class="font-medium">Please select both start and end dates for custom range.</span>
            </div>
        </div>
    </div>

</div>

<!-- Loading Modal -->
<div id="loadingModal" class="loading-modal hidden" onclick="closeLoadingModal(event)" style="position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; display: none; align-items: center; justify-content: center; z-index: 9999;">
    <div class="bg-white rounded-2xl p-8 text-center shadow-2xl" onclick="event.stopPropagation()" style="max-width: 400px; margin: auto;">
        <div class="loading-spinner"></div>
        <h3 class="text-xl font-bold text-gray-900 mb-2">Generating Your Report</h3>
        <p class="text-gray-600">Please wait while we compile your performance data...</p>
        <div class="mt-4 bg-gray-200 rounded-full h-2">
            <div id="progressBar" class="bg-gradient-to-r from-indigo-500 to-purple-600 h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
        </div>
        <button onclick="forceCloseModal()" class="mt-4 text-sm text-gray-500 hover:text-gray-700 underline focus:outline-none">
            Cancel
        </button>
    </div>
</div>

<!-- Notification Container -->
<div id="notificationContainer" class="fixed top-4 right-4 z-50 space-y-2"></div>

<script>
// Global variables
let selectedPeriod = 'last_month';
let isGenerating = false;

// Period selection function
function selectPeriod(period, buttonElement) {
    console.log('Selecting period:', period);

    if (isGenerating) {
        showNotification('Report generation in progress. Please wait.', 'warning');
        return;
    }

    // Remove active classes from all buttons
    document.querySelectorAll('.period-btn').forEach(btn => {
        btn.classList.remove('bg-gradient-to-r', 'from-indigo-500', 'to-purple-600', 'text-white', 'shadow-lg', 'transform', '-translate-y-1');
        btn.classList.add('bg-white', 'border-gray-200', 'hover:border-indigo-500');

        // Reset icon and text colors
        const icon = btn.querySelector('i');
        const title = btn.querySelector('span:first-of-type');
        const desc = btn.querySelector('span:last-of-type');
        if (icon) icon.className = icon.className.replace('text-white', 'text-gray-600');
        if (title) title.className = title.className.replace('text-white', 'text-gray-900');
        if (desc) desc.className = desc.className.replace('opacity-90', 'text-gray-600');
    });

    // Add active classes to selected button
    buttonElement.classList.remove('bg-white', 'border-gray-200', 'hover:border-indigo-500');
    buttonElement.classList.add('bg-gradient-to-r', 'from-indigo-500', 'to-purple-600', 'text-white', 'shadow-lg', 'transform', '-translate-y-1');

    // Update icon and text colors for active button
    const icon = buttonElement.querySelector('i');
    const title = buttonElement.querySelector('span:first-of-type');
    const desc = buttonElement.querySelector('span:last-of-type');
    if (icon) icon.className = icon.className.replace('text-gray-600', 'text-white');
    if (title) title.className = title.className.replace('text-gray-900', 'text-white');
    if (desc) desc.className = desc.className.replace('text-gray-600', 'opacity-90');

    selectedPeriod = period;

    // Show/hide custom date range
    const customDateRange = document.getElementById('customDateRange');
    if (customDateRange) {
        if (period === 'custom') {
            customDateRange.classList.add('show');
            // Focus on first date input after animation
            setTimeout(() => {
                const dateFromInput = document.getElementById('dateFrom');
                if (dateFromInput) dateFromInput.focus();
            }, 300);
        } else {
            customDateRange.classList.remove('show');
        }
    }

    // Update generate button text
    updateGenerateButtonText();

    // Hide any previous error messages
    hideError();

    // Show success notification
    const periodNames = {
        'last_month': 'Last Month',
        'last_quarter': 'Last Quarter',
        'ytd': 'Year to Date',
        'all_time': 'All Time',
        'last_week': 'Last Week',
        'custom': 'Custom Range'
    };

    showNotification(`Selected: ${periodNames[period]}`, 'success');
}

// Generate report function
function generateReport() {
    console.log('Generating report for period:', selectedPeriod);

    if (isGenerating) {
        showNotification('Report generation already in progress', 'warning');
        return;
    }

    // Validate custom date range if selected
    if (selectedPeriod === 'custom') {
        const dateFrom = document.getElementById('dateFrom').value;
        const dateTo = document.getElementById('dateTo').value;

        if (!dateFrom || !dateTo) {
            showError('Please select both start and end dates for custom range.');
            return;
        }

        if (new Date(dateFrom) > new Date(dateTo)) {
            showError('Start date cannot be after end date.');
            return;
        }
    }

    // Start generation process
    isGenerating = true;
    showLoadingModal();
    setGenerateButtonLoading(true);

    // Failsafe: Always hide modal after 5 seconds maximum
    setTimeout(() => {
        if (isGenerating) {
            console.warn('Forcing modal close due to timeout');
            isGenerating = false;
            hideLoadingModal();
            setGenerateButtonLoading(false);
            showNotification('Report generation took longer than expected. Please try again.', 'warning');
        }
    }, 5000);

    // Build URL with parameters
    let url = '/generate-report/';
    const params = new URLSearchParams();

    if (selectedPeriod === 'custom') {
        const dateFrom = document.getElementById('dateFrom').value;
        const dateTo = document.getElementById('dateTo').value;
        params.append('date_from', dateFrom);
        params.append('date_to', dateTo);
    } else {
        params.append('period', selectedPeriod);
    }

    if (params.toString()) {
        url += '?' + params.toString();
    }

    console.log('Report URL:', url);

    // Create a hidden link to trigger download
    console.log('Generating report with URL:', url);

    // Show progress for 1.5 seconds then trigger download
    setTimeout(() => {
        try {
            // Create a temporary link element to trigger download
            const link = document.createElement('a');
            link.href = url;
            link.target = '_blank';
            link.style.display = 'none';

            // Add to DOM, click, then remove
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);

            // Show success message
            showNotification('Report generated successfully! Check your downloads folder.', 'success');

        } catch (error) {
            console.error('Error generating report:', error);
            showNotification('Error generating report. Please try again.', 'error');
        }

        // Always reset state
        isGenerating = false;
        hideLoadingModal();
        setGenerateButtonLoading(false);
    }, 1500); // 1.5 second delay to show loading state
}

// Update generate button text based on selected period
function updateGenerateButtonText() {
    const btnText = document.getElementById('generateBtnText');
    if (!btnText) return;

    const periodText = {
        'last_month': 'Last Month',
        'last_quarter': 'Last Quarter',
        'ytd': 'Year to Date',
        'all_time': 'All Time',
        'last_week': 'Last Week',
        'custom': 'Custom Range'
    };

    const period = periodText[selectedPeriod] || 'Performance';
    btnText.textContent = `Generate ${period} Report`;
}

// Utility functions
function showNotification(message, type = 'info') {
    const container = document.getElementById('notificationContainer');
    if (!container) return;

    const notification = document.createElement('div');
    const colors = {
        'success': 'bg-green-500',
        'error': 'bg-red-500',
        'info': 'bg-blue-500',
        'warning': 'bg-yellow-500'
    };

    const icons = {
        'success': 'fa-check-circle',
        'error': 'fa-exclamation-circle',
        'info': 'fa-info-circle',
        'warning': 'fa-exclamation-triangle'
    };

    notification.className = `${colors[type]} text-white px-6 py-4 rounded-xl shadow-lg flex items-center space-x-3 transform translate-x-full transition-transform duration-300`;
    notification.innerHTML = `
        <i class="fas ${icons[type]} text-xl"></i>
        <span class="font-medium">${message}</span>
        <button onclick="this.parentElement.remove()" class="ml-2 text-white hover:text-gray-200 focus:outline-none">
            <i class="fas fa-times"></i>
        </button>
    `;

    container.appendChild(notification);

    // Show notification
    setTimeout(() => {
        notification.classList.remove('translate-x-full');
    }, 100);

    // Auto remove after 5 seconds
    setTimeout(() => {
        if (notification.parentElement) {
            notification.classList.add('translate-x-full');
            setTimeout(() => notification.remove(), 300);
        }
    }, 5000);
}

function showError(message) {
    const errorDiv = document.getElementById('errorMessage');
    const errorText = document.getElementById('errorText');

    if (errorDiv && errorText) {
        errorText.textContent = message;
        errorDiv.classList.remove('hidden');

        // Auto-hide after 5 seconds
        setTimeout(() => {
            errorDiv.classList.add('hidden');
        }, 5000);
    }

    showNotification(message, 'error');
}

function hideError() {
    const errorDiv = document.getElementById('errorMessage');
    if (errorDiv) {
        errorDiv.classList.add('hidden');
    }
}

function showLoadingModal() {
    const modal = document.getElementById('loadingModal');
    if (modal) {
        modal.classList.remove('hidden');
        modal.style.display = 'flex';
        modal.style.alignItems = 'center';
        modal.style.justifyContent = 'center';
        modal.style.position = 'fixed';
        modal.style.top = '0';
        modal.style.left = '0';
        modal.style.width = '100vw';
        modal.style.height = '100vh';
        modal.style.zIndex = '9999';
        modal.style.backgroundColor = 'rgba(0, 0, 0, 0.5)';
        animateProgressBar();
    }
}

function hideLoadingModal() {
    const modal = document.getElementById('loadingModal');
    if (modal) {
        modal.style.display = 'none';
        modal.classList.add('hidden');
        const progressBar = document.getElementById('progressBar');
        if (progressBar) {
            progressBar.style.width = '0%';
        }
        // Clear any progress intervals
        if (window.progressInterval) {
            clearInterval(window.progressInterval);
            window.progressInterval = null;
        }
    }
}

function closeLoadingModal(event) {
    // Only close if clicking on the backdrop (not the modal content)
    if (event.target === event.currentTarget) {
        forceCloseModal();
    }
}

function forceCloseModal() {
    console.log('Force closing modal');
    isGenerating = false;
    hideLoadingModal();
    setGenerateButtonLoading(false);
    showNotification('Report generation cancelled', 'info');
}

function animateProgressBar() {
    const progressBar = document.getElementById('progressBar');
    if (!progressBar) return;

    let progress = 0;
    const interval = setInterval(() => {
        progress += Math.random() * 15;
        if (progress > 90) progress = 90;

        progressBar.style.width = progress + '%';

        if (progress >= 90) {
            clearInterval(interval);
        }
    }, 200);

    window.progressInterval = interval;
}

function setGenerateButtonLoading(loading) {
    const btn = document.getElementById('generateReportBtn');
    const text = document.getElementById('generateBtnText');

    if (btn && text) {
        if (loading) {
            btn.disabled = true;
            btn.classList.add('opacity-60', 'cursor-not-allowed');
            text.innerHTML = '<i class="fas fa-spinner fa-spin mr-3 text-xl"></i>Generating Report...';
        } else {
            btn.disabled = false;
            btn.classList.remove('opacity-60', 'cursor-not-allowed');
            updateGenerateButtonText();
        }
    }
}

// Initialize page when DOM is loaded
document.addEventListener('DOMContentLoaded', function() {
    console.log('Initializing tailor report page...');

    // Ensure loading modal is hidden on page load
    const modal = document.getElementById('loadingModal');
    if (modal) {
        modal.classList.add('hidden');
        modal.classList.remove('show');
    }

    // Initialize default date values
    const today = new Date();
    const lastMonth = new Date(today.getFullYear(), today.getMonth() - 1, today.getDate());

    const dateFromInput = document.getElementById('dateFrom');
    const dateToInput = document.getElementById('dateTo');

    if (dateFromInput && dateToInput) {
        // Set default values
        dateFromInput.value = lastMonth.toISOString().split('T')[0];
        dateToInput.value = today.toISOString().split('T')[0];

        // Set max date to today
        const todayStr = today.toISOString().split('T')[0];
        dateFromInput.max = todayStr;
        dateToInput.max = todayStr;

        // Add validation
        dateFromInput.addEventListener('change', validateDates);
        dateToInput.addEventListener('change', validateDates);
    }

    console.log('Page initialization complete');
});

function validateDates() {
    const dateFrom = document.getElementById('dateFrom').value;
    const dateTo = document.getElementById('dateTo').value;

    if (dateFrom && dateTo && new Date(dateFrom) > new Date(dateTo)) {
        showError('Start date cannot be after end date.');
        return false;
    }

    hideError();
    return true;
}

// Make functions globally available
window.selectPeriod = selectPeriod;
window.generateReport = generateReport;
window.closeLoadingModal = closeLoadingModal;
window.forceCloseModal = forceCloseModal;

console.log('Tailor report page script loaded successfully');
</script>

{% endblock %}
