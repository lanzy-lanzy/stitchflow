{% extends 'base.html' %}

{% block title %}Customer Management - El Senior Dumingag{% endblock %}

{% block content %}
<div class="bg-white rounded-lg shadow-md p-6">
    <div class="flex justify-between items-center mb-6">
        <h2 class="text-2xl font-bold text-gray-800">Customer Management</h2>
        <div class="flex space-x-2">
            <button id="refreshBtn" class="bg-gray-600 text-white px-4 py-2 rounded-lg hover:bg-gray-700">
                <i class="fas fa-sync-alt mr-2"></i>Refresh
            </button>
            <button id="createCustomerBtn" class="bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700">
                <i class="fas fa-user-plus mr-2"></i>Create Customer
            </button>
        </div>
    </div>
    
    <!-- Search and Filter -->
    <div class="mb-6">
        <div class="flex flex-col md:flex-row md:items-center md:space-x-4 space-y-4 md:space-y-0">
            <div class="flex-1">
                <input type="text" id="searchInput" placeholder="Search customers by name or phone..." 
                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-200 focus:border-indigo-500">
            </div>
            <div>
                <select id="statusFilter" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-200 focus:border-indigo-500">
                    <option value="">All Statuses</option>
                    <option value="active">Active</option>
                    <option value="inactive">Inactive</option>
                </select>
            </div>
            <button id="searchBtn" class="bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700">
                <i class="fas fa-search mr-2"></i>Search
            </button>
        </div>
    </div>
    
    <!-- Customer Table -->
    <div class="overflow-x-auto">
        <table class="min-w-full bg-white border border-gray-200">
            <thead>
                <tr class="bg-gray-100">
                    <th class="py-2 px-4 border-b text-left">ID</th>
                    <th class="py-2 px-4 border-b text-left">Name</th>
                    <th class="py-2 px-4 border-b text-left">Phone</th>
                    <th class="py-2 px-4 border-b text-left">Email</th>
                    <th class="py-2 px-4 border-b text-left">Orders</th>
                    <th class="py-2 px-4 border-b text-left">Status</th>
                    <th class="py-2 px-4 border-b text-left">Actions</th>
                </tr>
            </thead>
            <tbody id="customerTableBody">
                <!-- Customer data will be loaded here -->
                <tr>
                    <td colspan="7" class="py-4 px-4 text-center text-gray-500">Loading customer data...</td>
                </tr>
            </tbody>
        </table>
    </div>
    
    <!-- Pagination -->
    <div class="flex justify-between items-center mt-6">
        <div class="text-gray-600">
            Showing <span id="startRecord">0</span> to <span id="endRecord">0</span> of <span id="totalRecords">0</span> records
        </div>
        <div class="flex space-x-2">
            <button id="prevPage" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 disabled:opacity-50" disabled>
                Previous
            </button>
            <button id="nextPage" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 disabled:opacity-50" disabled>
                Next
            </button>
        </div>
    </div>
</div>

<!-- Create/Edit Customer Modal -->
<div id="customerModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
    <div class="bg-white rounded-lg p-6 w-full max-w-2xl max-h-screen overflow-y-auto">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-xl font-bold" id="modalTitle">Create Customer</h3>
            <button id="closeModal" class="text-gray-500 hover:text-gray-700">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <form id="customerForm">
            <input type="hidden" id="customerId">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                <div>
                    <label class="block text-gray-700 mb-2" for="firstName">First Name</label>
                    <input type="text" id="firstName" class="w-full px-3 py-2 border border-gray-300 rounded-md" required>
                </div>
                <div>
                    <label class="block text-gray-700 mb-2" for="lastName">Last Name</label>
                    <input type="text" id="lastName" class="w-full px-3 py-2 border border-gray-300 rounded-md" required>
                </div>
                <div>
                    <label class="block text-gray-700 mb-2" for="phone">Phone Number</label>
                    <input type="text" id="phone" class="w-full px-3 py-2 border border-gray-300 rounded-md" required>
                </div>
                <div>
                    <label class="block text-gray-700 mb-2" for="email">Email</label>
                    <input type="email" id="email" class="w-full px-3 py-2 border border-gray-300 rounded-md">
                </div>
                <div class="md:col-span-2">
                    <label class="block text-gray-700 mb-2" for="address">Address</label>
                    <textarea id="address" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-md"></textarea>
                </div>
            </div>
            
            <div class="mb-4">
                <h4 class="text-lg font-semibold mb-2">Measurements</h4>
                <div id="measurementsContainer">
                    <!-- Measurements will be added here dynamically -->
                </div>
                <button type="button" id="addMeasurementBtn" class="mt-2 text-indigo-600 hover:text-indigo-800">
                    <i class="fas fa-plus mr-1"></i>Add Measurement
                </button>
            </div>
            
            <div class="flex justify-end space-x-2">
                <button type="button" id="cancelCustomerBtn" class="px-4 py-2 bg-gray-300 text-gray-700 rounded-md hover:bg-gray-400">Cancel</button>
                <button type="submit" class="px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700">Save Customer</button>
            </div>
        </form>
    </div>
</div>

<script>
    // Get CSRF token
    const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');
    
    // Current page and pagination info
    let currentPage = 1;
    let totalPages = 1;
    let totalRecords = 0;
    
    // Load customer data when page loads
    document.addEventListener('DOMContentLoaded', function() {
        loadCustomerData();
    });
    
    // Refresh button
    document.getElementById('refreshBtn').addEventListener('click', function() {
        loadCustomerData();
    });
    
    // Create customer button
    document.getElementById('createCustomerBtn').addEventListener('click', function() {
        openCustomerModal();
    });
    
    // Close modal buttons
    document.getElementById('closeModal').addEventListener('click', closeCustomerModal);
    document.getElementById('cancelCustomerBtn').addEventListener('click', closeCustomerModal);
    
    // Search button
    document.getElementById('searchBtn').addEventListener('click', function() {
        currentPage = 1;
        loadCustomerData();
    });
    
    // Search input enter key
    document.getElementById('searchInput').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            currentPage = 1;
            loadCustomerData();
        }
    });
    
    // Pagination buttons
    document.getElementById('prevPage').addEventListener('click', function() {
        if (currentPage > 1) {
            currentPage--;
            loadCustomerData();
        }
    });
    
    // Add measurement button
    document.getElementById('addMeasurementBtn').addEventListener('click', function() {
        addMeasurementField();
    });
    
    // Customer form submission
    document.getElementById('customerForm').addEventListener('submit', function(e) {
        e.preventDefault();
        saveCustomer();
    });
    
    function loadCustomerData() {
        const searchQuery = document.getElementById('searchInput').value;
        const statusFilter = document.getElementById('statusFilter').value;
        
        // In a real implementation, this would call the customer management API
        // For now, we'll simulate the data loading
        const customerTableBody = document.getElementById('customerTableBody');
        customerTableBody.innerHTML = '<tr><td colspan="7" class="py-4 px-4 text-center text-gray-500">Loading customer data...</td></tr>';
        
        // Simulate API call delay
        setTimeout(() => {
            // Mock data for demonstration
            const customers = [
                {
                    id: 1,
                    firstName: 'John',
                    lastName: 'Doe',
                    phone: '+1234567890',
                    email: 'john.doe@example.com',
                    orders: 3,
                    status: 'active'
                },
                {
                    id: 2,
                    firstName: 'Jane',
                    lastName: 'Smith',
                    phone: '+1987654321',
                    email: 'jane.smith@example.com',
                    orders: 1,
                    status: 'active'
                }
            ];
            
            renderCustomerTable(customers);
            updatePagination(2, 1, 10);
        }, 500);
    }
    
    function renderCustomerTable(customers) {
        const customerTableBody = document.getElementById('customerTableBody');
        customerTableBody.innerHTML = '';
        
        if (customers.length === 0) {
            customerTableBody.innerHTML = '<tr><td colspan="7" class="py-4 px-4 text-center text-gray-500">No customers found</td></tr>';
            return;
        }
        
        customers.forEach(customer => {
            const row = document.createElement('tr');
            row.className = 'hover:bg-gray-50';
            row.innerHTML = `
                <td class="py-2 px-4 border-b">${customer.id}</td>
                <td class="py-2 px-4 border-b">${customer.firstName} ${customer.lastName}</td>
                <td class="py-2 px-4 border-b">${customer.phone}</td>
                <td class="py-2 px-4 border-b">${customer.email || 'N/A'}</td>
                <td class="py-2 px-4 border-b">${customer.orders}</td>
                <td class="py-2 px-4 border-b">
                    <span class="px-2 py-1 rounded-full text-xs ${customer.status === 'active' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
                        ${customer.status.charAt(0).toUpperCase() + customer.status.slice(1)}
                    </span>
                </td>
                <td class="py-2 px-4 border-b">
                    <button class="text-indigo-600 hover:text-indigo-900 mr-2 edit-customer" data-id="${customer.id}" title="Edit">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="text-blue-600 hover:text-blue-900 mr-2 create-order" data-id="${customer.id}" title="Create Order">
                        <i class="fas fa-shopping-cart"></i>
                    </button>
                    <button class="text-red-600 hover:text-red-900 delete-customer" data-id="${customer.id}" title="Delete">
                        <i class="fas fa-trash"></i>
                    </button>
                </td>
            `;
            customerTableBody.appendChild(row);
        });
        
        // Add event listeners to action buttons
        document.querySelectorAll('.edit-customer').forEach(button => {
            button.addEventListener('click', function() {
                const customerId = this.getAttribute('data-id');
                editCustomer(customerId);
            });
        });
        
        document.querySelectorAll('.create-order').forEach(button => {
            button.addEventListener('click', function() {
                const customerId = this.getAttribute('data-id');
                createOrderForCustomer(customerId);
            });
        });
        
        document.querySelectorAll('.delete-customer').forEach(button => {
            button.addEventListener('click', function() {
                const customerId = this.getAttribute('data-id');
                deleteCustomer(customerId);
            });
        });
    }
    
    function updatePagination(total, current, records) {
        totalRecords = total;
        currentPage = current;
        totalPages = Math.ceil(total / records);
        
        document.getElementById('startRecord').textContent = ((current - 1) * records) + 1;
        document.getElementById('endRecord').textContent = Math.min(current * records, total);
        document.getElementById('totalRecords').textContent = total;
        
        document.getElementById('prevPage').disabled = current === 1;
        document.getElementById('nextPage').disabled = current === totalPages;
    }
    
    function openCustomerModal(customer = null) {
        document.getElementById('customerModal').classList.remove('hidden');
        document.getElementById('customerModal').classList.add('flex');
        
        if (customer) {
            // Edit mode
            document.getElementById('modalTitle').textContent = 'Edit Customer';
            document.getElementById('customerId').value = customer.id;
            document.getElementById('firstName').value = customer.firstName;
            document.getElementById('lastName').value = customer.lastName;
            document.getElementById('phone').value = customer.phone;
            document.getElementById('email').value = customer.email || '';
            document.getElementById('address').value = customer.address || '';
            
            // Clear and populate measurements
            document.getElementById('measurementsContainer').innerHTML = '';
            if (customer.measurements) {
                Object.keys(customer.measurements).forEach(key => {
                    addMeasurementField(key, customer.measurements[key]);
                });
            }
        } else {
            // Create mode
            document.getElementById('modalTitle').textContent = 'Create Customer';
            document.getElementById('customerForm').reset();
            document.getElementById('customerId').value = '';
            document.getElementById('measurementsContainer').innerHTML = '';
        }
    }
    
    function closeCustomerModal() {
        document.getElementById('customerModal').classList.add('hidden');
        document.getElementById('customerModal').classList.remove('flex');
    }
    
    function addMeasurementField(key = '', value = '') {
        const container = document.getElementById('measurementsContainer');
        const measurementDiv = document.createElement('div');
        measurementDiv.className = 'flex space-x-2 mb-2 measurement-field';
        measurementDiv.innerHTML = `
            <input type="text" placeholder="Measurement name" value="${key}" class="flex-1 px-3 py-2 border border-gray-300 rounded-md measurement-key">
            <input type="text" placeholder="Value" value="${value}" class="flex-1 px-3 py-2 border border-gray-300 rounded-md measurement-value">
            <button type="button" class="px-3 py-2 bg-red-500 text-white rounded-md remove-measurement">
                <i class="fas fa-times"></i>
            </button>
        `;
        container.appendChild(measurementDiv);
        
        // Add event listener to remove button
        measurementDiv.querySelector('.remove-measurement').addEventListener('click', function() {
            container.removeChild(measurementDiv);
        });
    }
    
    function saveCustomer() {
        // In a real implementation, this would save the customer via API
        alert('Customer saved successfully!');
        closeCustomerModal();
        loadCustomerData();
    }
    
    function editCustomer(customerId) {
        // In a real implementation, this would fetch customer details via API
        // For now, we'll simulate with mock data
        const customer = {
            id: customerId,
            firstName: 'John',
            lastName: 'Doe',
            phone: '+1234567890',
            email: 'john.doe@example.com',
            address: '123 Main St, City, State',
            measurements: {
                'Chest': '42',
                'Waist': '36'
            }
        };
        openCustomerModal(customer);
    }
    
    function createOrderForCustomer(customerId) {
        // Redirect to create order page with customer pre-selected
        window.location.href = `/create-order/?customer=${customerId}`;
    }
    
    function deleteCustomer(customerId) {
        if (confirm('Are you sure you want to delete this customer?')) {
            // In a real implementation, this would delete the customer via API
            alert('Customer deleted successfully!');
            loadCustomerData();
        }
    }
</script>
{% endblock %}